<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>Add Variables Using External Data - Programs</title>

<script src="site_libs/header-attrs-2.7/header-attrs.js"></script>
<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/bootstrap.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>








<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.tab('show');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row">
<div class="col-sm-12 col-md-4 col-lg-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-sm-12 col-md-8 col-lg-9">



<div id="topdiv" class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <!-- NOTE: add "navbar-inverse" class for an alternate navbar background -->
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">USDA BB Dataset Pipelines</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <!-- NEW DATASET -->
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
            Corelogic01

            <span class="caret"></span>
          </a>
          <ul class="dropdown-menu" role="menu">
            <li style="border: 1px solid silver; border-top: 1px solid silver; text-align: center">
              INGEST
            </li>
            <li>
              <a href="dp_ds01_10.html">Import Notes</a>
            </li>
            <li>
              <a href="dp_ds01_11.html">Import Parallel</a>
            </li>
            <li>
              <a href="dp_ds01_12.html">Clean & Type</a>
            </li>
            <li style="border-bottom: 1px solid silver; border-top: 1px solid silver; text-align: center">
              STRUCTURE
            </li>
            <li>
              <a href="dp_ds01_20.html">Profile Structure</a>
            </li>
            <li>
              <a href="dp_ds01_21.html">Latest Data</a>
            </li>
            <li style="border-bottom: 1px solid silver; border-top: 1px solid silver; text-align: center">
              NEW VARIABLES
            </li>
            <li>
              <a href="dp_ds01_30.html">New Variable Notes</a>
            </li>
            <li>
              <a href="dp_ds01_31.html">Add Variables (Internal)</a>
            </li>
            <li>
              <a href="dp_ds01_32.html">Add Variables (External) 1</a>
            </li>
            <li>
              <a href="dp_ds01_33.html">Add Variables (External) 2</a>
            </li>
            <li style="border-bottom: 1px solid silver; border-top: 1px solid silver; text-align: center">
              QUALITY
            </li>
            <li>
              <a href="dp_ds01_40.html">Profile Quality</a>
            </li>
            <li>
              <a href="dp_ds01_41.html">Filter Values</a>
            </li>
            <li>
              <a href="dp_ds01_42.html">Validate Values</a>
            </li>
            <li style="border-bottom: 1px solid silver; border-top: 1px solid silver; text-align: center">
              ANALYZE
            </li>
            <li>
              <a href="dp_ds01_50.html">Analysis Notes</a>
            </li>
          </ul>
        </li>

        <!-- NEW DATASET -->
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
            Census Blocks 2018

            <span class="caret"></span>
          </a>
          <ul class="dropdown-menu" role="menu">
            <li style="border: 1px solid silver; border-top: 1px solid silver; text-align: center">
              INGEST
            </li>
            <li>
              <a href="dp_ds02_10.html">Import Notes</a> -->
            </li>
            <li>
              <a href="">blank</a>
            </li>
            <li style="border-bottom: 1px solid silver; border-top: 1px solid silver; text-align: center">
              STRUCTURE
            </li>
            <li>
              <!-- <a href="dp_ds02_20.html">Profile Structure</a> -->
            </li>
            <li>
              <a href="">blank</a>
            </li>
            <li style="border-bottom: 1px solid silver; border-top: 1px solid silver; text-align: center">
              NEW VARIABLES
            </li>
            <li>
              <!-- <a href="dp_ds02_30.html">New Variable Notes</a> -->
            </li>
            <li>
              <a href="">blank</a>
            </li>
            <li style="border-bottom: 1px solid silver; border-top: 1px solid silver; text-align: center">
              QUALITY
            </li>
            <li>
              <!-- <a href="dp_ds02_40.html">Profile Quality</a> -->
            </li>
            <li>
              <a href="">blank</a>
            </li>
            <li style="border-bottom: 1px solid silver; border-top: 1px solid silver; text-align: center">
              ANALYZE
            </li>
            <li>
              <!-- <a href="dp_ds02_50.html">Analysis Notes</a> -->
            </li>
            <li>
              <a href="">blank</a>
            </li>
          </ul>
        </li>

        <!-- NEW DATASET -->
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
            rogram Eligibility Dataset 2014

            <span class="caret"></span>
          </a>
          <ul class="dropdown-menu" role="menu">
            <li style="border: 1px solid silver; border-top: 1px solid silver; text-align: center">
              INGEST
            </li>
            <li>
              <a href="dp_ds03_10.html">Import Notes</a>
            </li>
            <li>
              <a href="dp_ds03_11.html">Import 2014 Data</a>
            </li>
            <li style="border-bottom: 1px solid silver; border-top: 1px solid silver; text-align: center">
              STRUCTURE
            </li>
            <li>
              <!-- <a href="dp_ds03_20.html">Profile Structure</a> -->
            </li>
            <li>
              <a href="">blank</a>
            </li>
            <li style="border-bottom: 1px solid silver; border-top: 1px solid silver; text-align: center">
              NEW VARIABLES
            </li>
            <li>
              <!-- <a href="dp_ds03_30.html">New Variable Notes</a> -->
            </li>
            <li>
              <a href="">blank</a>
            </li>
            <li style="border-bottom: 1px solid silver; border-top: 1px solid silver; text-align: center">
              QUALITY
            </li>
            <li>
              <!-- <a href="dp_ds03_40.html">Profile Quality</a> -->
            </li>
            <li>
              <a href="">blank</a>
            </li>
            <li style="border-bottom: 1px solid silver; border-top: 1px solid silver; text-align: center">
              ANALYZE
            </li>
            <li>
              <!-- <a href="dp_ds03_50.html">Analysis Notes</a> -->
            </li>
            <li>
              <a href="">blank</a>
            </li>
          </ul>
        </li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">



<h1 class="title toc-ignore">Add Variables Using External Data - Programs</h1>

</div>


<hr />
<p>We add columns to the dataset for <strong>each USDA broadband program</strong>. Each program column will contain a program identifier code for each property that is within the eligibility area for that program. We create these columns by finding the geographic intersection of the program’s eligibility areas (as specified in their respective shapefiles) with the coordinates of the corelogic properties. The final output is a new table with a column for each broadband program. If a property is physically within the eligibility area for one of the programs, then a program identifier is entered in that program’s column.</p>
<div id="load-libraries-and-functions" class="section level2">
<h2>Load libraries and functions</h2>
<pre class="r"><code>source(&quot;../R/functions.R&quot;)
library(data.table)
library(RPostgreSQL)
library(sf)
library(glue)
library(magrittr)</code></pre>
<div id="set-geo-data-directory" class="section level3">
<h3>Set Geo Data Directory</h3>
<pre class="r"><code># {r, cache=TRUE}
geodatadir &lt;- &quot;../../../data/projects_data/usda/bb/original/geo&quot;</code></pre>
</div>
<div id="get-list-of-all-u.s.-counties" class="section level3">
<h3>Get list of all U.S. counties</h3>
<p>For use with program data that don’t have county fips codes. Convert list to sf.</p>
<pre class="r"><code># {r, cache=TRUE}
counties_us &lt;- tigris::counties() %&gt;%
  sf::st_transform(4326)</code></pre>
</div>
</div>
<div id="cc-program-eligible-properties" class="section level2">
<h2>CC Program Eligible Properties</h2>
<div id="load-broadband-program-area-shapefiles" class="section level4">
<h4>Load broadband program area shapefiles</h4>
<pre class="r"><code># {r, cache=TRUE}
map_program_area_cc &lt;- st_read(file.path(geodatadir, &quot;CC 2013_2019_83 04272020.shp&quot;)) %&gt;%
  sf::st_transform(4326)</code></pre>
</div>
<div id="create-list-of-county-fips-codes-that-are-within-the-program-area-for-the-database-query" class="section level4">
<h4>Create list of county FIPS codes that are within the program area for the database query</h4>
<pre class="r"><code># {r}
counties_cc &lt;- paste0(&quot;&#39;&quot;, paste(unique(strsplit(paste(map_program_area_cc$FIPS, collapse = &quot;, &quot;), &quot;, &quot;)[[1]]), collapse = &quot;&#39;,&#39;&quot;), &quot;&#39;&quot;)

counties_cc_sql &lt;- glue_sql(counties_cc)</code></pre>
</div>
<div id="get-property-records-for-the-program-related-counties-from-the-database" class="section level4">
<h4>Get property records for the program related counties from the database</h4>
<pre class="r"><code># {r}
con &lt;- get_db_conn(db_host = &quot;localhost&quot;, db_port = 5434)</code></pre>
<pre class="sql"><code>-- {sql connection=con, output.var=&quot;qry_res&quot;}
SELECT geoid_cnty, p_id_iris_frmtd, property_centroid_longitude, property_centroid_latitude FROM corelogic_usda.current_tax_200627_latest_all_add_vars 
WHERE property_centroid_longitude IS NOT NULL 
AND geoid_cnty IN (?counties_cc_sql);</code></pre>
<pre class="r"><code># {r}
DBI::dbDisconnect(con)</code></pre>
</div>
<div id="get-intersection-between-program-area-shapefile-and-the-selected-properties" class="section level4">
<h4>Get intersection between program area shapefile and the selected properties</h4>
<p>First convert database query result to an sf object.</p>
<pre class="r"><code># {r}
db_rows_cc &lt;- st_as_sf(qry_res, coords = c(&quot;property_centroid_longitude&quot;, &quot;property_centroid_latitude&quot;), crs = 4326)

int &lt;- sf::st_intersects(db_rows_cc, map_program_area_cc)
int2 &lt;- as.integer(as.character(int))</code></pre>
</div>
<div id="add-rusid-to-intersecting-properties" class="section level4">
<h4>Add RUSID to intersecting properties</h4>
<pre class="r"><code># {r}
db_rows_cc$program &lt;- &quot;CC&quot;
db_rows_cc$rusid &lt;- as.character(map_program_area_cc$RUSID[unlist(int2)])
db_rows_cc &lt;- db_rows_cc[!is.na(db_rows_cc$rusid),]</code></pre>
</div>
</div>
<div id="rc-program-eligible-properties" class="section level2">
<h2>RC Program Eligible Properties</h2>
<div id="load-broadband-program-area-shapefiles-1" class="section level4">
<h4>Load broadband program area shapefiles</h4>
<pre class="r"><code># {r, cache=TRUE}
map_program_area_rc &lt;- st_read(file.path(geodatadir, &quot;ReConnect R1 594 PFSA 05012020.shp&quot;)) %&gt;%
  sf::st_transform(4326)</code></pre>
</div>
<div id="create-list-of-county-fips-codes-that-are-within-the-program-area-for-the-database-query-1" class="section level4">
<h4>Create list of county FIPS codes that are within the program area for the database query</h4>
<p>This dataset does not have a county FIPS code. Instead it provides a list of county names associated with that entry. We need to do some work to convert these lists of county names to a list of unique county fips codes.</p>
<pre class="r"><code># {r}
int &lt;- sf::st_intersects(map_program_area_rc, counties_us)

cnty_ints &lt;- data.table(rc_rownum = numeric(), cntys_rownum = numeric(), geoid = character())
for (i in 1:length(int)) {
  u &lt;- unlist(int[i])
  for (j in 1:length(int[[i]])) {
    geoid &lt;- counties_us[u[j],]$GEOID
    newrow &lt;- data.table(rc_rownum = i, cntys_rownum = u[j], geoid)
    cnty_ints &lt;- rbindlist(list(cnty_ints, newrow))
    #print(paste(i, u[j]))
  }
}

cnty_ints_geoid &lt;- cnty_ints[, .(geoid_cntys = paste(geoid, collapse = &quot;, &quot;)), rc_rownum]
map_program_area_rc$geoid_cnty &lt;- &quot;&quot;

for (i in 1:nrow(cnty_ints_geoid)) {
  map_program_area_rc[cnty_ints_geoid[i,]$rc_rownum,]$geoid_cnty &lt;- cnty_ints_geoid[i,]$geoid_cntys
}

geoid_cnty_unq &lt;- unique(strsplit(paste(map_program_area_rc$geoid_cnty, collapse = &quot;, &quot;), &quot;, &quot;)[[1]])
geoid_cnty_unq &lt;- geoid_cnty_unq[geoid_cnty_unq != &quot;&quot;]
counties_rc &lt;- paste0(&quot;&#39;&quot;, paste(geoid_cnty_unq, collapse = &quot;&#39;,&#39;&quot;), &quot;&#39;&quot;)

counties_rc_sql &lt;- glue_sql(counties_rc)</code></pre>
</div>
<div id="get-property-records-for-the-program-related-counties-from-the-database-1" class="section level4">
<h4>Get property records for the program related counties from the database</h4>
<pre class="r"><code># {r}
con &lt;- get_db_conn(db_host = &quot;localhost&quot;, db_port = 5434)</code></pre>
<pre class="sql"><code>-- {sql connection=con, output.var=&quot;qry_res&quot;}
SELECT geoid_cnty, p_id_iris_frmtd, property_centroid_longitude, property_centroid_latitude FROM corelogic_usda.current_tax_200627_latest_all_add_vars 
WHERE property_centroid_longitude IS NOT NULL 
AND geoid_cnty IN (?counties_rc_sql);</code></pre>
<pre class="r"><code># {r}
DBI::dbDisconnect(con)</code></pre>
</div>
<div id="get-intersection-between-program-area-shapefile-and-the-selected-properties-1" class="section level4">
<h4>Get intersection between program area shapefile and the selected properties</h4>
<p>First convert database query result to an sf object.</p>
<pre class="r"><code># {r}
db_rows_rc &lt;- st_as_sf(qry_res, coords = c(&quot;property_centroid_longitude&quot;, &quot;property_centroid_latitude&quot;), crs = 4326)

int &lt;- sf::st_intersects(db_rows_rc, map_program_area_rc)
int2 &lt;- as.integer(as.character(int))</code></pre>
</div>
<div id="add-rusid-to-intersecting-properties-1" class="section level4">
<h4>Add RUSID to intersecting properties</h4>
<pre class="r"><code># {r}
db_rows_rc$program &lt;- &quot;RC&quot;
db_rows_rc$rusid &lt;- as.character(map_program_area_rc$RUS_ID[unlist(int2)])
db_rows_rc &lt;- db_rows_rc[!is.na(db_rows_rc$rusid),]</code></pre>
</div>
</div>
<div id="bip-program-eligible-properties" class="section level2">
<h2>BIP Program Eligible Properties</h2>
<div id="load-broadband-program-area-shapefiles-2" class="section level4">
<h4>Load broadband program area shapefiles</h4>
<pre class="r"><code># {r, cache=TRUE}
map_program_area_bip &lt;- st_read(file.path(geodatadir, &quot;200409_BIP_ServAr_ID.shp&quot;)) %&gt;%
  sf::st_transform(4326)</code></pre>
</div>
<div id="create-list-of-county-fips-codes-that-are-within-the-program-area-for-the-database-query-2" class="section level4">
<h4>Create list of county FIPS codes that are within the program area for the database query</h4>
<p>This dataset does not have a county FIPS code. Instead it provides a list of county names associated with that entry. We need to do some work to convert these lists of county names to a list of unique county fips codes.</p>
<pre class="r"><code># {r}
int &lt;- sf::st_intersects(map_program_area_bip, counties_us)

cnty_ints &lt;- data.table(rc_rownum = numeric(), cntys_rownum = numeric(), geoid = character())
for (i in 1:length(int)) {
  u &lt;- unlist(int[i])
  for (j in 1:length(int[[i]])) {
    geoid &lt;- counties_us[u[j],]$GEOID
    newrow &lt;- data.table(rc_rownum = i, cntys_rownum = u[j], geoid)
    cnty_ints &lt;- rbindlist(list(cnty_ints, newrow))
  }
}

cnty_ints_geoid &lt;- cnty_ints[, .(geoid_cntys = paste(geoid, collapse = &quot;, &quot;)), rc_rownum]
map_program_area_bip$geoid_cnty &lt;- &quot;&quot;

for (i in 1:nrow(cnty_ints_geoid)) {
  map_program_area_bip[cnty_ints_geoid[i,]$rc_rownum,]$geoid_cnty &lt;- cnty_ints_geoid[i,]$geoid_cntys
}

geoid_cnty_unq &lt;- unique(strsplit(paste(map_program_area_bip$geoid_cnty, collapse = &quot;, &quot;), &quot;, &quot;)[[1]])
geoid_cnty_unq &lt;- geoid_cnty_unq[geoid_cnty_unq != &quot;&quot;]
counties_bip &lt;- paste0(&quot;&#39;&quot;, paste(geoid_cnty_unq, collapse = &quot;&#39;,&#39;&quot;), &quot;&#39;&quot;)

counties_bip_sql &lt;- glue_sql(counties_bip)</code></pre>
</div>
<div id="get-property-records-for-the-program-related-counties-from-the-database-2" class="section level4">
<h4>Get property records for the program related counties from the database</h4>
<pre class="r"><code># {r}
con &lt;- get_db_conn(db_host = &quot;localhost&quot;, db_port = 5434)</code></pre>
<pre class="sql"><code>-- {sql connection=con, output.var=&quot;qry_res&quot;}
SELECT geoid_cnty, p_id_iris_frmtd, property_centroid_longitude, property_centroid_latitude FROM corelogic_usda.current_tax_200627_latest_all_add_vars 
WHERE property_centroid_longitude IS NOT NULL
AND property_centroid_latitude IS NOT NULL
AND geoid_cnty IN (?counties_bip_sql);</code></pre>
<pre class="r"><code># {r}
DBI::dbDisconnect(con)</code></pre>
</div>
<div id="get-intersection-between-program-area-shapefile-and-the-selected-properties-2" class="section level4">
<h4>Get intersection between program area shapefile and the selected properties</h4>
<p>First convert database query result to an sf object.</p>
<pre class="r"><code># {r}
db_rows_bip &lt;- st_as_sf(qry_res, coords = c(&quot;property_centroid_longitude&quot;, &quot;property_centroid_latitude&quot;), crs = 4326)

int &lt;- sf::st_intersects(db_rows_bip, map_program_area_bip)
int2 &lt;- as.integer(as.character(int))</code></pre>
</div>
<div id="add-rusid-to-intersecting-properties-2" class="section level4">
<h4>Add RUSID to intersecting properties</h4>
<pre class="r"><code># {r}
db_rows_bip$program &lt;- &quot;BIP&quot;
db_rows_bip$rusid &lt;- as.character(map_program_area_bip$RUS_ID[unlist(int2)])
db_rows_bip &lt;- db_rows_bip[!is.na(db_rows_bip$rusid),]</code></pre>
</div>
</div>
<div id="tcf-program-eligible-properties" class="section level2">
<h2>TCF Program Eligible Properties</h2>
<div id="load-broadband-program-area-shapefiles-3" class="section level4">
<h4>Load broadband program area shapefiles</h4>
<pre class="r"><code># {r, cache=TRUE}
map_program_area_tcf &lt;- st_read(file.path(geodatadir, &quot;USDARD_RUS_TELCO_FARMBILL_06042020/USDARD_RUS_TELCO_FARMBILL_06042020.shp&quot;)) %&gt;%
  sf::st_transform(4326)</code></pre>
</div>
<div id="create-list-of-county-fips-codes-that-are-within-the-program-area-for-the-database-query-3" class="section level4">
<h4>Create list of county FIPS codes that are within the program area for the database query</h4>
<p>This dataset does not have a county FIPS code. Instead it provides a list of county names associated with that entry. We need to do some work to convert these lists of county names to a list of unique county fips codes.</p>
<pre class="r"><code># {r}
int &lt;- sf::st_intersects(map_program_area_tcf, counties_us)

cnty_ints &lt;- data.table(rc_rownum = numeric(), cntys_rownum = numeric(), geoid = character())
for (i in 1:length(int)) {
  u &lt;- unlist(int[i])
  for (j in 1:length(int[[i]])) {
    geoid &lt;- counties_us[u[j],]$GEOID
    newrow &lt;- data.table(rc_rownum = i, cntys_rownum = u[j], geoid)
    cnty_ints &lt;- rbindlist(list(cnty_ints, newrow))
    #print(paste(i, u[j]))
  }
}

cnty_ints_geoid &lt;- cnty_ints[, .(geoid_cntys = paste(geoid, collapse = &quot;, &quot;)), rc_rownum]
map_program_area_tcf$geoid_cnty &lt;- &quot;&quot;

for (i in 1:nrow(cnty_ints_geoid)) {
  map_program_area_tcf[cnty_ints_geoid[i,]$rc_rownum,]$geoid_cnty &lt;- cnty_ints_geoid[i,]$geoid_cntys
}

geoid_cnty_unq &lt;- unique(strsplit(paste(map_program_area_tcf$geoid_cnty, collapse = &quot;, &quot;), &quot;, &quot;)[[1]])
geoid_cnty_unq &lt;- geoid_cnty_unq[geoid_cnty_unq != &quot;&quot;]
counties_tcf &lt;- paste0(&quot;&#39;&quot;, paste(geoid_cnty_unq, collapse = &quot;&#39;,&#39;&quot;), &quot;&#39;&quot;)

counties_tcf_sql &lt;- glue_sql(counties_tcf)</code></pre>
</div>
<div id="get-property-records-for-the-program-related-counties-from-the-database-3" class="section level4">
<h4>Get property records for the program related counties from the database</h4>
<pre class="r"><code># {r}
con &lt;- get_db_conn(db_host = &quot;localhost&quot;, db_port = 5434)</code></pre>
<pre class="sql"><code>-- {sql connection=con, output.var=&quot;qry_res&quot;}
SELECT geoid_cnty, p_id_iris_frmtd, property_centroid_longitude, property_centroid_latitude FROM corelogic_usda.current_tax_200627_latest_all_add_vars 
WHERE property_centroid_longitude IS NOT NULL 
AND property_centroid_latitude IS NOT NULL
AND geoid_cnty IN (?counties_tcf_sql);</code></pre>
<pre class="r"><code># {r}
DBI::dbDisconnect(con)</code></pre>
</div>
<div id="get-intersection-between-program-area-shapefile-and-the-selected-properties-3" class="section level4">
<h4>Get intersection between program area shapefile and the selected properties</h4>
<p>First convert database query result to an sf object.</p>
<pre class="r"><code># {r}
db_rows_tcf &lt;- st_as_sf(qry_res, coords = c(&quot;property_centroid_longitude&quot;, &quot;property_centroid_latitude&quot;), crs = 4326)

int &lt;- sf::st_intersects(db_rows_tcf, map_program_area_tcf)
int2 &lt;- as.integer(as.character(int))</code></pre>
</div>
<div id="add-rusid-to-intersecting-properties-3" class="section level3">
<h3>Add RUSID to intersecting properties</h3>
<pre class="r"><code># {r}
db_rows_tcf$program &lt;- &quot;TCF&quot;
db_rows_tcf$rusid &lt;- as.character(map_program_area_tcf$RUS_ID[unlist(int2)])
db_rows_tcf &lt;- db_rows_tcf[!is.na(db_rows_tcf$rusid),]</code></pre>
</div>
</div>
<div id="tci-program-eligible-properties" class="section level2">
<h2>TCI Program Eligible Properties</h2>
<div id="load-broadband-program-area-shapefiles-4" class="section level4">
<h4>Load broadband program area shapefiles</h4>
<pre class="r"><code># {r, cache=TRUE}
map_program_area_tci &lt;- st_read(file.path(geodatadir, &quot;USDARD_RUS_TELCO_INFRA_06042020/USDARD_RUS_TELCO_INFRA_06042020.shp&quot;)) %&gt;%
  sf::st_transform(4326)</code></pre>
</div>
<div id="create-list-of-county-fips-codes-that-are-within-the-program-area-for-the-database-query-4" class="section level4">
<h4>Create list of county FIPS codes that are within the program area for the database query</h4>
<p>This dataset does not have a county FIPS code. Instead it provides a list of county names associated with that entry. We need to do some work to convert these lists of county names to a list of unique county fips codes.</p>
<pre class="r"><code># {r}
int &lt;- sf::st_intersects(map_program_area_tci, counties_us)

cnty_ints &lt;- data.table(rc_rownum = numeric(), cntys_rownum = numeric(), geoid = character())
for (i in 1:length(int)) {
  u &lt;- unlist(int[i])
  for (j in 1:length(int[[i]])) {
    geoid &lt;- counties_us[u[j],]$GEOID
    newrow &lt;- data.table(rc_rownum = i, cntys_rownum = u[j], geoid)
    cnty_ints &lt;- rbindlist(list(cnty_ints, newrow))
    #print(paste(i, u[j]))
  }
}

cnty_ints_geoid &lt;- cnty_ints[, .(geoid_cntys = paste(geoid, collapse = &quot;, &quot;)), rc_rownum]
map_program_area_tci$geoid_cnty &lt;- &quot;&quot;

for (i in 1:nrow(cnty_ints_geoid)) {
  map_program_area_tci[cnty_ints_geoid[i,]$rc_rownum,]$geoid_cnty &lt;- cnty_ints_geoid[i,]$geoid_cntys
}

geoid_cnty_unq &lt;- unique(strsplit(paste(map_program_area_tci$geoid_cnty, collapse = &quot;, &quot;), &quot;, &quot;)[[1]])
geoid_cnty_unq &lt;- geoid_cnty_unq[geoid_cnty_unq != &quot;&quot;]
counties_tci &lt;- paste0(&quot;&#39;&quot;, paste(geoid_cnty_unq, collapse = &quot;&#39;,&#39;&quot;), &quot;&#39;&quot;)

counties_tci_sql &lt;- glue_sql(counties_tci)</code></pre>
</div>
<div id="get-property-records-for-the-program-related-counties-from-the-database-4" class="section level4">
<h4>Get property records for the program related counties from the database</h4>
<pre class="r"><code># {r}
con &lt;- get_db_conn(db_host = &quot;localhost&quot;, db_port = 5434)</code></pre>
<pre class="sql"><code>-- {sql connection=con, output.var=&quot;qry_res&quot;}
SELECT geoid_cnty, p_id_iris_frmtd, property_centroid_longitude, property_centroid_latitude FROM corelogic_usda.current_tax_200627_latest_all_add_vars 
WHERE property_centroid_longitude IS NOT NULL 
AND property_centroid_latitude IS NOT NULL
AND geoid_cnty IN (?counties_tci_sql);</code></pre>
<pre class="r"><code># {r}
DBI::dbDisconnect(con)</code></pre>
</div>
<div id="get-intersection-between-program-area-shapefile-and-the-selected-properties-4" class="section level4">
<h4>Get intersection between program area shapefile and the selected properties</h4>
<p>First convert database query result to an sf object.</p>
<pre class="r"><code># {r}
db_rows_tci &lt;- st_as_sf(qry_res, coords = c(&quot;property_centroid_longitude&quot;, &quot;property_centroid_latitude&quot;), crs = 4326)

int &lt;- sf::st_intersects(db_rows_tci, map_program_area_tci)
int2 &lt;- as.integer(as.character(int))</code></pre>
</div>
<div id="add-rusid-to-intersecting-properties-4" class="section level4">
<h4>Add RUSID to intersecting properties</h4>
<pre class="r"><code># {r}
db_rows_tci$program &lt;- &quot;TCI&quot;
db_rows_tci$rusid &lt;- as.character(map_program_area_tci$RUSID[unlist(int2)])
db_rows_tci &lt;- db_rows_tci[!is.na(db_rows_tci$rusid),]</code></pre>
</div>
</div>
<div id="combine-all-program-eligible-properties" class="section level2">
<h2>Combine All Program Eligible Properties</h2>
<pre class="r"><code># {r}
combn &lt;- rbindlist(list(db_rows_cc, db_rows_rc, db_rows_bip, db_rows_tcf, db_rows_tci))

combn_cast &lt;- dcast(combn, geoid_cnty + p_id_iris_frmtd ~ program, value.var = &quot;rusid&quot;)

saveRDS(combn_cast, file.path(geodatadir, &quot;program_eligible_properties.RDS&quot;))</code></pre>
</div>
<div id="write-combined-data-to-the-database" class="section level2">
<h2>Write combined data to the database</h2>
<pre class="r"><code># {r}
con &lt;- get_db_conn(db_host = &quot;localhost&quot;, db_port = 5434)

dbWriteTable(con, c(&quot;corelogic_usda&quot;, &quot;current_tax_200627_program_eligible_properties&quot;), combn_cast, overwrite = TRUE, row.names = FALSE)

dbExecute(con, &quot;ALTER TABLE corelogic_usda.current_tax_200627_program_eligible_properties ADD PRIMARY KEY (geoid_cnty, p_id_iris_frmtd)&quot;)

DBI::dbDisconnect(con)</code></pre>
</div>
<div id="join-new-table-with-current_tax_200627_latest_all_add_vars" class="section level2">
<h2>Join new table with current_tax_200627_latest_all_add_vars</h2>
<pre class="sql"><code>-- {sql} * Run In psql/pgcli
SELECT a.*, b.&quot;BIP&quot;, b.&quot;CC&quot;, b.&quot;RC&quot;, b.&quot;TCF&quot;, b.&quot;TCI&quot;
INTO corelogic_usda.current_tax_200627_latest_all_add_vars_add_progs
FROM corelogic_usda.current_tax_200627_latest_all_add_vars a
LEFT JOIN corelogic_usda.current_tax_200627_program_eligible_properties b
ON a.geoid_cnty = b.geoid_cnty AND a.p_id_iris_frmtd = b.p_id_iris_frmtd;

ALTER TABLE corelogic_usda.current_tax_200627_latest_all_add_vars_add_progs ADD PRIMARY KEY (geoid_cnty, p_id_iris_frmtd);</code></pre>
</div>



</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->

<script>
$(document).ready(function ()  {

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_');
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
