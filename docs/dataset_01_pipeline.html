<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>Dataset 1 Pipeline</title>

<script src="site_libs/header-attrs-2.7/header-attrs.js"></script>
<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/bootstrap.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>








<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.tab('show');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row">
<div class="col-sm-12 col-md-4 col-lg-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-sm-12 col-md-8 col-lg-9">



<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <!-- NOTE: add "navbar-inverse" class for an alternate navbar background -->
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">ERS Broadband Dataset Pipeline</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li><a href="index.html">Home</a></li>
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
            Ingest

            <span class="caret"></span>
          </a>
          <ul class="dropdown-menu" role="menu">
            <li>
              <a href="data_pipeline_01.html">Import (Parallel)</a>
            </li>
            <li>
              <a href="data_pipeline_02_clean_and_type.html">Fix Types</a>
            </li>
          </ul>
        </li>
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
            Profile

            <span class="caret"></span>
          </a>
          <ul class="dropdown-menu" role="menu">
            <li class="dropdown-header">Structure</li>
            <li>
              <a href="data_pipeline_08_profile_variables.html">Quality - Single Variables</a>
            </li>
            <li class="dropdown-header">Quality - Related Variables</li>
            <li class="dropdown-header">Metadata</li>
          </ul>
        </li>
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
            Re-Structure

            <span class="caret"></span>
          </a>
          <ul class="dropdown-menu" role="menu">
            <li>
              <a href="data_pipeline_03_build_latest_data_set.html">Unique &amp; Latest</a>
            </li>
            <li>
              <a href="data_pipeline_04_add_vars_transforms.html">New Vars from Transform</a>
            </li>
            <li>
              <a href="data_pipeline_05_add_vars_external.html">New Vars from External</a>
            </li>
            <li>
              <a href="data_pipeline_05_add_vars_external_2.html">Add Geography</a>
            </li>
          </ul>
        </li>
        <li>
          <a href="data_pipeline_07_filter_records.html">Enhance Quality</a>
        </li>
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
            Re-Profile

            <span class="caret"></span>
          </a>
          <ul class="dropdown-menu" role="menu">
            <li class="dropdown-header">Structure</li>
            <li>
              <a href="data_pipeline_08_profile_variables.html">Quality - Single Variables</a>
            </li>
            <li class="dropdown-header">Quality - Related Variables</li>
            <li class="dropdown-header">Metadata</li>
          </ul>
        </li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li><a href="https://github.com">GitHub</a></li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">



<h1 class="title toc-ignore">Dataset 1 Pipeline</h1>

</div>


<hr />
<div id="dataset-info" class="section level1">
<h1>DATASET INFO</h1>
<div id="input-data-title" class="section level4">
<h4>Input Data Title</h4>
<p>Corelogic USDA Current Tax Roll through 06/27/2020</p>
</div>
<div id="input-data-delivered-data" class="section level4">
<h4>Input Data Delivered Data</h4>
<p>07/06/2020</p>
</div>
<div id="input-data-type-format" class="section level4">
<h4>Input Data Type &amp; Format</h4>
<p>Administrative; CSV</p>
</div>
<div id="input-data-location" class="section level4">
<h4>Input Data Location</h4>
<p>/project/biocomplexity/sdad/projects_data/usda/bb/original/Corelogic_June_2020_Files/Corelogic_USDA_Current_Tax_2020_06_27.txt</p>
</div>
<div id="input-data-dictionary" class="section level4">
<h4>Input Data Dictionary</h4>
<p>/project/biocomplexity/sdad/projects_data/usda/bb/original/L – TAX – Bulk Historical Tax Roll.xlsx</p>
</div>
<div id="input-data-provider" class="section level4">
<h4>Input Data Provider</h4>
<p>CoreLogic</p>
</div>
<div id="input-data-license" class="section level4">
<h4>Input Data License</h4>
<p>Proprietary, <link to contract></p>
</div>
<div id="output-data-format" class="section level4">
<h4>Output Data Format</h4>
<p>Database table</p>
</div>
<div id="output-data-location" class="section level4">
<h4>Output Data Location</h4>
<p>corelogic_usda.current_tax_200627_latest_final</p>
<hr />
</div>
</div>
<div id="ingest" class="section level1">
<h1>INGEST</h1>
<div id="split-and-parallel-import" class="section level2">
<h2>SPLIT AND PARALLEL IMPORT</h2>
<div id="load-libraries-and-functions" class="section level3">
<h3>Load libraries and functions</h3>
<pre class="r"><code># {r}
source(&quot;R/functions.R&quot;)
library(data.table)
library(dataplumbr)
library(foreach)
library(doParallel)
library(DBI)</code></pre>
</div>
<div id="set-variables" class="section level3">
<h3>Set variables</h3>
<div id="files-and-directories" class="section level4">
<h4>Files and directories</h4>
<pre class="r"><code># {r}
file_dir &lt;- &quot;/project/biocomplexity/sdad/projects_data/usda/bb/original/Corelogic_June_2020_Files&quot;
file_name &lt;- &quot;Corelogic_USDA_Current_Tax_2020_06_27.txt&quot;
file_path &lt;- file.path(file_dir, file_name)</code></pre>
</div>
<div id="database" class="section level4">
<h4>Database</h4>
<pre class="r"><code># {r}
schema_name &lt;- &quot;corelogic_usda&quot;
table_name &lt;- &quot;current_tax_200627_raw&quot;</code></pre>
</div>
</div>
<div id="use-system-level-commands-to-split-large-file" class="section level3">
<h3>Use system-level commands to split large file</h3>
<div id="set-system-level-bash-environmental-variables" class="section level4">
<h4>Set System-Level (bash) Environmental Variables</h4>
<p>System-level environmental variables are set to enable their use by command line functions</p>
<pre class="r"><code># {r}
Sys.setenv(file_dir=file_dir)
Sys.setenv(file_path=file_path)</code></pre>
</div>
<div id="create-directory-for-split-files-from-the-terminal" class="section level4">
<h4>Create directory for split files from the terminal</h4>
<pre class="bash"><code># {bash}
mkdir $file_dir/splits/
rm -r $file_dir/splits/*</code></pre>
</div>
<div id="split-large-file-by-number-of-lines-per-file" class="section level4">
<h4>Split large file by number of lines per file</h4>
<p>Use system split function to create files not too large to be handled for import into R. In this case we are creating files with a maximum of 1,000,000 lines each</p>
<pre class="bash"><code># {bash} * Might run in terminal depending on size
split -l1000000 $file_path $file_dir/splits/</code></pre>
</div>
</div>
<div id="read-and-prepare-first-split-file" class="section level3">
<h3>Read and prepare first split file</h3>
<div id="get-first-split-file-path-and-read-with-data.table" class="section level4">
<h4>Get first split file path and read with data.table</h4>
<pre class="r"><code># {r}
file_paths &lt;- list.files(path = file.path(file_dir, &quot;splits&quot;), full.names = T)
first_split_file &lt;- file_paths[1]
tbl &lt;- fread(first_split_file, colClasses = &quot;character&quot;, select = 1:188, quote = &quot;&quot;)</code></pre>
</div>
<div id="standardize-column-names-for-the-database" class="section level4">
<h4>Standardize column names for the database</h4>
<pre class="r"><code># {r}
db_col_names &lt;- dataplumbr::name.standard_col_names(colnames(tbl)) %&gt;%
  stringr::str_replace(&quot;^_&quot;, &quot;&quot;) %&gt;%
  stringr::str_replace(&quot;_$&quot;, &quot;&quot;)
colnames(tbl) &lt;- db_col_names</code></pre>
</div>
</div>
<div id="write-data-to-new-database-table" class="section level3">
<h3>Write data to new database table</h3>
<pre class="r"><code># {r}
con &lt;- get_db_conn()
dbWriteTable(con, c(schema_name, table_name), tbl, overwrite = T, row.names = F)
dbDisconnect(con)

rm(tbl)</code></pre>
</div>
<div id="read-remaining-split-files-and-upload-to-database" class="section level3">
<h3>Read remaining split files and upload to database</h3>
<pre class="r"><code># {r}
# core_num &lt;- parallel::detectCores() - 2
cl &lt;- makeCluster(6, outfile = &quot;src/parlog&quot;)
doParallel::registerDoParallel(cl)

# num_files &lt;- length(file_paths)

res &lt;- foreach(i = 151:179) %dopar% {
  con &lt;- get_db_conn()
  print(paste(&quot;reading&quot;, file_paths[i]))
  dt &lt;- data.table::fread(file_paths[i], colClasses = &quot;character&quot;, header = FALSE, select = 1:188, quote = &quot;&quot;)
  colnames(dt) &lt;- db_col_names
  db_res &lt;- RPostgreSQL::dbWriteTable(con, c(schema_name, table_name), dt, append = TRUE, row.names = FALSE)
  print(paste(db_res, &quot;written&quot;, file_paths[i]))
  DBI::dbDisconnect(con)
  rm(dt)
}

parallel::stopCluster(cl)</code></pre>
<hr />
</div>
</div>
<div id="select-type-title" class="section level2">
<h2>SELECT, TYPE &amp; TITLE</h2>
<div id="load-libraries-and-functions-1" class="section level3">
<h3>Load libraries and functions</h3>
<pre class="r"><code># {r}
source(&quot;../R/functions.R&quot;)
library(DBI)</code></pre>
<div id="function-for-testing-if-a-string-value-is-a-valid-date" class="section level4">
<h4>Function for testing if a string value is a valid date</h4>
<pre class="r"><code># {r}
con &lt;- get_db_conn()</code></pre>
<pre class="sql"><code># {sql connection=con}
create or replace function is_date(s varchar) 
returns boolean as $$
 begin
   perform s::date;
   return true;
 exception when others then
   return false;
 end;
 $$ language plpgsql;</code></pre>
<pre class="r"><code># {r}
dbDisconnect(con)</code></pre>
</div>
<div id="function-for-cleaning-character-strings-in-this-case-only-removing-double-quotes.-if-string-is-empty-after-cleaning-returns-null." class="section level4">
<h4>Function for cleaning character strings (in this case only removing double quotes). If string is empty after cleaning, returns null.</h4>
<pre class="r"><code># {r}
con &lt;- get_db_conn()</code></pre>
<pre class="sql"><code>-- {sql connection=con}
create or replace function clean_char(s varchar) 
returns varchar as $cleaned$
 declare
   cleaned varchar;
 begin
   SELECT NULLIF(REPLACE(s, &#39;&quot;&#39;, &#39;&#39;), &#39;&#39;) INTO cleaned;
   return cleaned;
 end;
 $cleaned$ language plpgsql;</code></pre>
<pre class="r"><code># {r}
dbDisconnect(con)</code></pre>
</div>
</div>
<div id="create-new-table-of-desired-columns-with-correct-data-types" class="section level3">
<h3>Create new table of desired columns with correct data types</h3>
<pre class="r"><code># {r}
con &lt;- get_db_conn()</code></pre>
<pre class="sql"><code>-- {sql connection=con}
CREATE TABLE corelogic_usda.current_tax_200627_typed
(
  geoid_cnty CHAR(5),
  p_id_iris_frmtd VARCHAR(75),
  property_indicator VARCHAR(5),
  zoning VARCHAR(100),
  municipality_name VARCHAR(255),
  municipality_code VARCHAR(20),
  acres NUMERIC(11,2),
  land_square_footage NUMERIC(11,2),
  property_centroid_longitude NUMERIC(9,6),
  property_centroid_latitude NUMERIC(9,6),
  bldg_code VARCHAR(10),
  building_square_feet NUMERIC(9,2),
  living_square_feet NUMERIC(9,2),
  year_built VARCHAR(8),
  effective_year_built VARCHAR(8),
  bedrooms NUMERIC(6,1),
  full_baths NUMERIC(6,1),
  qtr_baths NUMERIC(6,1),
  thrqtr_baths NUMERIC(6,1),
  half_baths NUMERIC(6,1),
  total_baths NUMERIC(6,1),
  situs_address VARCHAR(255),
  situs_zip_code VARCHAR(10),
  mail_address VARCHAR(255),
  mail_zip_code VARCHAR(10),
  sale_code VARCHAR(5),
  sale_price NUMERIC,
  sale_date DATE,
  recording_date DATE,
  transaction_type VARCHAR(5),
  tax_amount NUMERIC,
  tax_year INTEGER,
  assessed_year INTEGER,
  total_value_calculated NUMERIC,
  land_value_calculated NUMERIC,
  improvement_value_calculated NUMERIC
)</code></pre>
<pre class="r"><code># {r}
dbDisconnect(con)</code></pre>
</div>
<div id="clean-and-set-column-data-types-and-insert-into-new-typed-table" class="section level3">
<h3>Clean and set column data types and insert into new typed table</h3>
<div id="first-fix-longitude-and-latitude-column-names" class="section level4">
<h4>First, Fix Longitude and Latitude Column Names!</h4>
<p>The column names are switched in this dataset! Longitude is latitude and vice versa. Therefore, the column names are reverse here to fix.</p>
<pre class="sql"><code>-- {sql} * Run In psql/pgcli
  INSERT INTO corelogic_usda.current_tax_200627_typed
  SELECT
  clean_char(fips_code) geoid_cnty, 
  clean_char(p_id_iris_frmtd) p_id_iris_frmtd, 
  clean_char(property_indicator) property_indicator, 
  clean_char(zoning) zoning, 
  clean_char(municipality_name) municipality_name, 
  clean_char(municipality_code) municipality_code,
  CAST(NULLIF(REPLACE(acres, &#39;&quot;&#39;, &#39;&#39;), &#39;&#39;) AS NUMERIC(11,2)) acres, 
  CAST(NULLIF(REPLACE(land_square_footage, &#39;&quot;&#39;, &#39;&#39;), &#39;&#39;) AS NUMERIC(11,2)) land_square_footage,
  
  CAST(NULLIF(REPLACE(property_centroid_longitude, &#39;&quot;&#39;, &#39;&#39;), &#39;&#39;) AS NUMERIC(9,6)) property_centroid_latitude, 
  CAST(NULLIF(REPLACE(property_centroid_latitude, &#39;&quot;&#39;, &#39;&#39;), &#39;&#39;) AS NUMERIC(9,6)) property_centroid_longitude, 
  
  clean_char(bldg_code) bldg_code, 
  CAST(NULLIF(REPLACE(building_square_feet, &#39;&quot;&#39;, &#39;&#39;), &#39;&#39;) AS NUMERIC(9,2)) building_square_feet, 
  CAST(NULLIF(REPLACE(living_square_feet, &#39;&quot;&#39;, &#39;&#39;), &#39;&#39;) AS NUMERIC(9,2)) living_square_feet, 
  clean_char(year_built) year_built, 
  clean_char(effective_year_built) effective_year_built,
  CAST(NULLIF(REPLACE(bedrooms, &#39;&quot;&#39;, &#39;&#39;), &#39;&#39;) AS NUMERIC(6,1)) bedrooms, 
  CAST(NULLIF(REPLACE(full_baths, &#39;&quot;&#39;, &#39;&#39;), &#39;&#39;) AS NUMERIC(6,1)) full_baths, 
  CAST(NULLIF(REPLACE(&quot;1qtr_baths&quot;, &#39;&quot;&#39;, &#39;&#39;), &#39;&#39;) AS NUMERIC(6,1)) qtr_baths, 
  CAST(NULLIF(REPLACE(&quot;3qtr_baths&quot;, &#39;&quot;&#39;, &#39;&#39;), &#39;&#39;) AS NUMERIC(6,1)) thrqtr_baths, 
  CAST(NULLIF(REPLACE(half_baths, &#39;&quot;&#39;, &#39;&#39;), &#39;&#39;) AS NUMERIC(6,1)) half_baths, 
  CAST(NULLIF(REPLACE(total_baths, &#39;&quot;&#39;, &#39;&#39;), &#39;&#39;) AS NUMERIC(6,1)) total_baths, 
  trim(
    replace( 
      replace(
        replace(
          coalesce(situs_house_number_prefix, &#39;&#39;) || &#39; &#39; ||
          coalesce(situs_house_number, &#39;&#39;) || &#39; &#39; ||
          coalesce(situs_direction, &#39;&#39;) || &#39; &#39; ||
          coalesce(situs_street_name, &#39;&#39;) || &#39; &#39; ||
          coalesce(situs_mode, &#39;&#39;) || &#39; &#39; ||
          coalesce(situs_quadrant, &#39;&#39;) || &#39; &#39; ||
          coalesce(situs_city, &#39;&#39;) || &#39; &#39; ||
          coalesce(situs_state, &#39;&#39;) || &#39; &#39; ||
          coalesce(situs_zip_code, &#39;&#39;),
        &#39;  &#39;, &#39; &#39;),
      &#39;  &#39;, &#39; &#39;),
      &#39;&quot;&#39;, &#39;&#39;)
  ) situs_address, 
  clean_char(situs_zip_code) situs_zip_code, 
  trim(
    replace(
     replace(
       replace(
         coalesce(mail_house_number_prefix, &#39;&#39;) || &#39; &#39; ||
         coalesce(mail_house_number, &#39;&#39;) || &#39; &#39; ||
         coalesce(mail_direction, &#39;&#39;) || &#39; &#39; ||
         coalesce(mail_street_name, &#39;&#39;) || &#39; &#39; ||
         coalesce(mail_mode, &#39;&#39;) || &#39; &#39; ||
         coalesce(mail_quadrant, &#39;&#39;) || &#39; &#39; ||
         coalesce(mail_city, &#39;&#39;) || &#39; &#39; ||
         coalesce(mail_state, &#39;&#39;) || &#39; &#39; ||
         coalesce(mail_zip_code, &#39;&#39;),
       &#39;  &#39;, &#39; &#39;),
     &#39;  &#39;, &#39; &#39;),
    &#39;&quot;&#39;, &#39;&#39;)
    ) mail_address, 
  clean_char(mail_zip_code) mail_zip_code,
  clean_char(sale_code) sale_code, 
  CAST(NULLIF(REPLACE(sale_price, &#39;&quot;&#39;, &#39;&#39;), &#39;&#39;) AS NUMERIC) sale_price, 
  CASE WHEN is_date(REPLACE(sale_date, &#39;&quot;&#39;, &#39;&#39;)) = TRUE THEN TO_DATE(NULLIF(REPLACE(sale_date, &#39;&quot;&#39;, &#39;&#39;), &#39;&#39;), &#39;YYYYMMDD&#39;) ELSE NULL END sale_date,
  CASE WHEN is_date(REPLACE(recording_date, &#39;&quot;&#39;, &#39;&#39;)) = TRUE THEN TO_DATE(NULLIF(REPLACE(recording_date, &#39;&quot;&#39;, &#39;&#39;), &#39;&#39;), &#39;YYYYMMDD&#39;) ELSE NULL END recording_date,
  clean_char(transaction_type) transaction_type,
  CAST(NULLIF(REPLACE(tax_amount, &#39;&quot;&#39;, &#39;&#39;), &#39;&#39;) AS NUMERIC) tax_amount, 
  CAST(NULLIF(REPLACE(tax_year, &#39;&quot;&#39;, &#39;&#39;), &#39;&#39;) AS INTEGER) tax_year, 
  CAST(NULLIF(REPLACE(assessed_year, &#39;&quot;&#39;, &#39;&#39;), &#39;&#39;) AS INTEGER) assessed_year, 
  CAST(NULLIF(REPLACE(total_value_calculated, &#39;&quot;&#39;, &#39;&#39;), &#39;&#39;) AS NUMERIC) total_value_calculated, 
  CAST(NULLIF(REPLACE(land_value_calculated, &#39;&quot;&#39;, &#39;&#39;), &#39;&#39;) AS NUMERIC) land_value_calculated,
  CAST(NULLIF(REPLACE(improvement_value_calculated, &#39;&quot;&#39;, &#39;&#39;), &#39;&#39;) AS NUMERIC) improvement_value_calculated
  FROM corelogic_usda.current_tax_200627_raw;</code></pre>
</div>
<div id="add-composite-index" class="section level4">
<h4>Add Composite Index</h4>
<pre class="sql"><code>-- {sql} * Run In psql/pgcli
DROP INDEX IF EXISTS current_tax_200627_typed_geoid_cnty_p_id_iris_frmtd_idx;
CREATE INDEX current_tax_200627_typed_geoid_cnty_p_id_iris_frmtd_idx ON corelogic_usda.current_tax_200627_typed (geoid_cnty, p_id_iris_frmtd);</code></pre>
<table>
<colgroup>
<col width="100%" />
</colgroup>
<tbody>
<tr class="odd">
<td align="left"># INITIAL PROFILE</td>
</tr>
<tr class="even">
<td align="left">## FIND STRUCTURAL ISSUES</td>
</tr>
<tr class="odd">
<td align="left">## FIND QUALITY ISSUES</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
<div id="restructure" class="section level1">
<h1>RESTRUCTURE</h1>
<div id="create-single-record-of-latest" class="section level2">
<h2>CREATE SINGLE RECORD OF LATEST</h2>
<p><strong>Create a Single Record of Latest Info for each Property</strong> - Administrative data records like real estate tax records have, by their nature, multiple entries over time of information related to some entity. For example, for a single property parcel there will be a separate entry for each sale that has occurred. However, it is rare for all pertinent information to be fully entered every time. For example, the number of bedrooms may be consistently entered when a sale occurs, but possibly not again when a record is entered for recording annual property tax not associated with a sale. Also, values can change over time from record to record (e.g property additions change the number of bedrooms). Also, it is reasonable to expect that the entries will not always be accurate (misspellings, transpositions, etc).</p>
<p>For real estate tax records it is reasonable to assume that the most recent entry is the most probably valid entry (e.g. number of bedrooms recently recorded will be more accurate than number of bedrooms recorded before an addition was added to the house). However, <strong>the most recent record will not necessarily have all of the needed information</strong> (see previous paragraph). Therefore, for each unique real estate parcel, we need to get the <strong>latest recorded value for each item/variable</strong> we are interested in using.</p>
<p>Accordingly, we create a <u>unique id table with a single record for each parcel</u> and <u>individual tables for each item/variable</u> (number of bedrooms, number of bathrooms, living square footage, etc.). These are then all joined to create a table of just the <strong>latest recorded information for each item/variable for each unique parcel</strong>.</p>
<div id="load-libraries-and-functions-2" class="section level3">
<h3>Load libraries and functions</h3>
<pre class="r"><code># {r}
source(&quot;../R/functions.R&quot;)
library(glue)</code></pre>
<div id="create-a-function-to-build-the-sql-queries-necessary-to-get-most-recent-item-recordings" class="section level4">
<h4>Create a function to build the SQL queries necessary to get most recent item recordings</h4>
<pre class="r"><code># {r}
build_latest_query &lt;- function(col_name) {
  tbl &lt;- glue(&quot;current_tax_200627_latest_{col_name}&quot;)
  glue_sql(&quot;
        DROP TABLE IF EXISTS corelogic_usda.{`tbl`};
        
        SELECT geoid_cnty, 
           p_id_iris_frmtd, 
           {`col_name`}
        INTO corelogic_usda.{`tbl`}
        FROM
        (
          SELECT geoid_cnty, 
                 p_id_iris_frmtd, 
                 {`col_name`},
                 sale_date,
                 ROW_NUMBER() OVER (PARTITION BY geoid_cnty, p_id_iris_frmtd ORDER BY sale_date DESC) as rec_num
          FROM corelogic_usda.current_tax_200627_typed
          WHERE sale_date IS NOT NULL
          AND p_id_iris_frmtd IS NOT NULL
          AND {`col_name`} IS NOT NULL
        ) t
        WHERE rec_num = 1;
        
        ALTER TABLE corelogic_usda.{`tbl`} ADD PRIMARY KEY (geoid_cnty, p_id_iris_frmtd);
           &quot;, .con = con)
}</code></pre>
</div>
</div>
<div id="create-unique-id-table" class="section level3">
<h3>Create Unique ID Table</h3>
<pre class="sql"><code>-- {sql} * Run In psql/pgcli
SELECT DISTINCT geoid_cnty, p_id_iris_frmtd
INTO corelogic_usda.current_tax_200627_unique_id
FROM corelogic_usda.current_tax_200627_typed
WHERE geoid_cnty IS NOT NULL
AND p_id_iris_frmtd IS NOT NULL;

ALTER TABLE corelogic_usda.current_tax_200627_unique_id ADD PRIMARY KEY (geoid_cnty, p_id_iris_frmtd);</code></pre>
<div id="run-build_latest_query-for-each-column-then-copy-the-sql-into-psqlpgcli" class="section level4">
<h4>Run build_latest_query for each column, then copy the SQL into psql/pgcli</h4>
<pre class="r"><code># {r}
build_latest_query(&quot;property_indicator&quot;)</code></pre>
<pre class="r"><code># {r}
build_latest_query(&quot;acres&quot;)</code></pre>
<pre class="r"><code># {r}
build_latest_query(&quot;land_square_footage&quot;)</code></pre>
<pre class="r"><code># {r}
build_latest_query(&quot;bldg_code&quot;)</code></pre>
<pre class="r"><code># {r}
build_latest_query(&quot;building_square_feet&quot;)</code></pre>
<pre class="r"><code># {r}
build_latest_query(&quot;living_square_feet&quot;)</code></pre>
<pre class="r"><code># {r}
build_latest_query(&quot;year_built&quot;)</code></pre>
<pre class="r"><code># {r}
build_latest_query(&quot;effective_year_built&quot;)</code></pre>
<pre class="r"><code># {r}
build_latest_query(&quot;bedrooms&quot;)</code></pre>
<pre class="r"><code># {r}
build_latest_query(&quot;full_baths&quot;)</code></pre>
<pre class="r"><code># {r}
build_latest_query(&quot;qtr_baths&quot;)</code></pre>
<pre class="r"><code># {r}
build_latest_query(&quot;thrqtr_baths&quot;)</code></pre>
<pre class="r"><code># {r}
build_latest_query(&quot;half_baths&quot;)</code></pre>
<pre class="r"><code># {r}
build_latest_query(&quot;total_baths&quot;)</code></pre>
<pre class="r"><code># {r}
build_latest_query(&quot;situs_address&quot;)</code></pre>
<pre class="r"><code># {r}
build_latest_query(&quot;mail_address&quot;)</code></pre>
<pre class="r"><code># {r}
build_latest_query(&quot;sale_code&quot;)</code></pre>
<pre class="r"><code># {r}
build_latest_query(&quot;sale_price&quot;)</code></pre>
<pre class="r"><code># {r}
build_latest_query(&quot;sale_date&quot;)</code></pre>
<pre class="r"><code># {r}
build_latest_query(&quot;recording_date&quot;)</code></pre>
<pre class="r"><code># {r}
build_latest_query(&quot;transaction_type&quot;)</code></pre>
<pre class="r"><code># {r}
build_latest_query(&quot;tax_year&quot;)</code></pre>
<pre class="r"><code># {r}
build_latest_query(&quot;property_centroid_longitude&quot;)</code></pre>
<pre class="r"><code># {r}
build_latest_query(&quot;property_centroid_latitude&quot;)</code></pre>
</div>
</div>
<div id="create-table-of-all-latest-information" class="section level3">
<h3>Create Table of All Latest Information</h3>
<pre class="sql"><code>-- {sql} * Run In psql/pgcli
SELECT a.geoid_cnty, a.p_id_iris_frmtd,
      acres, land_square_footage, bldg_code, building_square_feet, living_square_feet,
      year_built, effective_year_built, bedrooms, full_baths, qtr_baths, thrqtr_baths,
      half_baths, total_baths, situs_address, mail_address, sale_code, sale_price,
      sale_date, recording_date, transaction_type, tax_year
 INTO corelogic_usda.current_tax_200627_latest_all
 FROM corelogic_usda.current_tax_200627_unique_id a
 LEFT JOIN corelogic_usda.current_tax_200627_latest_acres b
   ON a.geoid_cnty = b.geoid_cnty AND a.p_id_iris_frmtd = b.p_id_iris_frmtd
 LEFT JOIN corelogic_usda.current_tax_200627_latest_land_square_footage c
   ON a.geoid_cnty = c.geoid_cnty AND a.p_id_iris_frmtd = c.p_id_iris_frmtd
 LEFT JOIN corelogic_usda.current_tax_200627_latest_bldg_code d
   ON a.geoid_cnty = d.geoid_cnty AND a.p_id_iris_frmtd = d.p_id_iris_frmtd
 LEFT JOIN corelogic_usda.current_tax_200627_latest_building_square_feet e
   ON a.geoid_cnty = e.geoid_cnty AND a.p_id_iris_frmtd = e.p_id_iris_frmtd
 LEFT JOIN corelogic_usda.current_tax_200627_latest_living_square_feet f
   ON a.geoid_cnty = f.geoid_cnty AND a.p_id_iris_frmtd = f.p_id_iris_frmtd
 LEFT JOIN corelogic_usda.current_tax_200627_latest_year_built g
   ON a.geoid_cnty = g.geoid_cnty AND a.p_id_iris_frmtd = g.p_id_iris_frmtd
 LEFT JOIN corelogic_usda.current_tax_200627_latest_effective_year_built h
   ON a.geoid_cnty = h.geoid_cnty AND a.p_id_iris_frmtd = h.p_id_iris_frmtd
 LEFT JOIN corelogic_usda.current_tax_200627_latest_bedrooms i
   ON a.geoid_cnty = i.geoid_cnty AND a.p_id_iris_frmtd = i.p_id_iris_frmtd
 LEFT JOIN corelogic_usda.current_tax_200627_latest_full_baths j
   ON a.geoid_cnty = j.geoid_cnty AND a.p_id_iris_frmtd = j.p_id_iris_frmtd
 LEFT JOIN corelogic_usda.current_tax_200627_latest_qtr_baths k
   ON a.geoid_cnty = k.geoid_cnty AND a.p_id_iris_frmtd = k.p_id_iris_frmtd
 LEFT JOIN corelogic_usda.current_tax_200627_latest_thrqtr_baths l
   ON a.geoid_cnty = l.geoid_cnty AND a.p_id_iris_frmtd = l.p_id_iris_frmtd
 LEFT JOIN corelogic_usda.current_tax_200627_latest_half_baths m
   ON a.geoid_cnty = m.geoid_cnty AND a.p_id_iris_frmtd = m.p_id_iris_frmtd
 LEFT JOIN corelogic_usda.current_tax_200627_latest_total_baths n
   ON a.geoid_cnty = n.geoid_cnty AND a.p_id_iris_frmtd = n.p_id_iris_frmtd
 LEFT JOIN corelogic_usda.current_tax_200627_latest_situs_address o
   ON a.geoid_cnty = o.geoid_cnty AND a.p_id_iris_frmtd = o.p_id_iris_frmtd
 LEFT JOIN corelogic_usda.current_tax_200627_latest_mail_address p
   ON a.geoid_cnty = p.geoid_cnty AND a.p_id_iris_frmtd = p.p_id_iris_frmtd
 LEFT JOIN corelogic_usda.current_tax_200627_latest_sale_code q
   ON a.geoid_cnty = q.geoid_cnty AND a.p_id_iris_frmtd = q.p_id_iris_frmtd
 LEFT JOIN corelogic_usda.current_tax_200627_latest_sale_price r
   ON a.geoid_cnty = r.geoid_cnty AND a.p_id_iris_frmtd = r.p_id_iris_frmtd
 LEFT JOIN corelogic_usda.current_tax_200627_latest_sale_date s
   ON a.geoid_cnty = s.geoid_cnty AND a.p_id_iris_frmtd = s.p_id_iris_frmtd
 LEFT JOIN corelogic_usda.current_tax_200627_latest_recording_date t
   ON a.geoid_cnty = t.geoid_cnty AND a.p_id_iris_frmtd = t.p_id_iris_frmtd
 LEFT JOIN corelogic_usda.current_tax_200627_latest_transaction_type u
   ON a.geoid_cnty = u.geoid_cnty AND a.p_id_iris_frmtd = u.p_id_iris_frmtd
 LEFT JOIN corelogic_usda.current_tax_200627_latest_tax_year v
   ON a.geoid_cnty = v.geoid_cnty AND a.p_id_iris_frmtd = v.p_id_iris_frmtd
 LEFT JOIN corelogic_usda.current_tax_200627_latest_property_centroid_longitude w
   ON a.geoid_cnty = w.geoid_cnty AND a.p_id_iris_frmtd = w.p_id_iris_frmtd
 LEFT JOIN corelogic_usda.current_tax_200627_latest_property_centroid_latitude x
   ON a.geoid_cnty = x.geoid_cnty AND a.p_id_iris_frmtd = x.p_id_iris_frmtd
 WHERE s.sale_date IS NOT NULL;

ALTER TABLE corelogic_usda.current_tax_200627_latest_all ADD PRIMARY KEY (geoid_cnty, p_id_iris_frmtd);</code></pre>
</div>
</div>
<div id="add-variables-transform-existing" class="section level2">
<h2>ADD VARIABLES (TRANSFORM EXISTING)</h2>
<div id="create-sale_year-variable" class="section level3">
<h3>Create sale_year variable</h3>
<p>Planned analyses include <strong>analysis by year of sale</strong>. Creating a separate indexed column for year should be faster than repeatedly using DATEPART(‘year’, sale_date).</p>
<pre class="sql"><code>SELECT DATE_PART(&#39;year&#39;, sale_date)::INTEGER AS sale_year</code></pre>
</div>
<div id="create-baths_appraised-variable" class="section level3">
<h3>Create baths_appraised variable</h3>
<p>Using the Fannie Mae and Freddie Mac Uniform Appraisal Dataset Specification to calculate total bathrooms. 3/4 baths count as full baths, 1/4 baths are dropped, half bath is .1 of full bath, so 1 x full bath &amp; 1 x 3/4 bath &amp; 1 x half bath = 2.1 baths (2 full baths, 1 half bath).</p>
<p>We use COALESCE to deal with NULL values because adding NULL values will always return NULL. COALESCE combines values, stopping at the first non-null value. So, if full_baths is NULL, the next non-null value ‘0’ will be used.</p>
<p>We use NULLIF on the result of the baths equation to test if the result is 0. A 0 would indicate that all of the bath types were NULL (it’s extremely unlikely to have a house with 0 bathrooms). Therefore, a total value of 0 is converted back to NULL, indicating that we have no information.</p>
<pre class="sql"><code>NULLIF(COALESCE(full_baths, 0) + 
       COALESCE(thrqtr_baths, 0) + 
       (.1 * COALESCE(half_baths, 0)), 0) AS baths_appraised</code></pre>
</div>
<div id="create-all-new-values-together-creating-a-new-table" class="section level3">
<h3>Create all new values together, creating a new table</h3>
<p>The <strong>fastest</strong> method to add new columns with values to a large dataset is to <strong>write everything to a new table</strong> (as opposed to the very slow operation of running an UPDATE on every record in the existing table). Therefore, we combine the creation of all new columns together in a single query creating a new table.</p>
<pre class="sql"><code>-- {sql} * Run In psql/pgcli
SELECT *,
       DATE_PART(&#39;year&#39;, sale_date)::INTEGER AS sale_year,
       NULLIF(coalesce(full_baths, 0) + coalesce(thrqtr_baths, 0) + (.1 * coalesce(half_baths, 0)), 0) AS baths_appraised
INTO corelogic_usda.current_tax_200627_latest_all_add_vars
FROM corelogic_usda.current_tax_200627_latest_all;

ALTER TABLE corelogic_usda.current_tax_200627_latest_all_add_vars ADD PRIMARY KEY (geoid_cnty, p_id_iris_frmtd);</code></pre>
<hr />
</div>
</div>
<div id="add-variables-external-data" class="section level2">
<h2>ADD VARIABLES (EXTERNAL DATA)</h2>
<p>We add columns to the dataset for <strong>each USDA broadband program</strong>. Each program column will contain a program identifier code for each property that is within the eligibility area for that program. We create these columns by finding the geographic intersection of the program’s eligibility areas (as specified in their respective shapefiles) with the coordinates of the corelogic properties. The final output is a new table with a column for each broadband program. If a property is physically within the eligibility area for one of the programs, then a program identifier is entered in that program’s column.</p>
<div id="load-libraries-and-functions-3" class="section level3">
<h3>Load libraries and functions</h3>
<pre class="r"><code>source(&quot;../R/functions.R&quot;)
library(data.table)
library(RPostgreSQL)
library(sf)
library(glue)
library(magrittr)</code></pre>
</div>
<div id="set-geo-data-directory" class="section level3">
<h3>Set Geo Data Directory</h3>
<pre class="r"><code># {r, cache=TRUE}
geodatadir &lt;- &quot;../../../data/projects_data/usda/bb/original/geo&quot;</code></pre>
</div>
<div id="get-list-of-all-u.s.-counties" class="section level3">
<h3>Get list of all U.S. counties</h3>
<p>For use with program data that don’t have county fips codes. Convert list to sf.</p>
<pre class="r"><code># {r, cache=TRUE}
counties_us &lt;- tigris::counties() %&gt;%
  sf::st_transform(4326)</code></pre>
</div>
<div id="cc-program-eligible-properties" class="section level3">
<h3>CC Program Eligible Properties</h3>
<div id="load-broadband-program-area-shapefiles" class="section level4">
<h4>Load broadband program area shapefiles</h4>
<pre class="r"><code># {r, cache=TRUE}
map_program_area_cc &lt;- st_read(file.path(geodatadir, &quot;CC 2013_2019_83 04272020.shp&quot;)) %&gt;%
  sf::st_transform(4326)</code></pre>
</div>
<div id="create-list-of-county-fips-codes-that-are-within-the-program-area-for-the-database-query" class="section level4">
<h4>Create list of county FIPS codes that are within the program area for the database query</h4>
<pre class="r"><code># {r}
counties_cc &lt;- paste0(&quot;&#39;&quot;, paste(unique(strsplit(paste(map_program_area_cc$FIPS, collapse = &quot;, &quot;), &quot;, &quot;)[[1]]), collapse = &quot;&#39;,&#39;&quot;), &quot;&#39;&quot;)

counties_cc_sql &lt;- glue_sql(counties_cc)</code></pre>
</div>
<div id="get-property-records-for-the-program-related-counties-from-the-database" class="section level4">
<h4>Get property records for the program related counties from the database</h4>
<pre class="r"><code># {r}
con &lt;- get_db_conn(db_host = &quot;localhost&quot;, db_port = 5434)</code></pre>
<pre class="sql"><code>-- {sql connection=con, output.var=&quot;qry_res&quot;}
SELECT geoid_cnty, p_id_iris_frmtd, property_centroid_longitude, property_centroid_latitude FROM corelogic_usda.current_tax_200627_latest_all_add_vars 
WHERE property_centroid_longitude IS NOT NULL 
AND geoid_cnty IN (?counties_cc_sql);</code></pre>
<pre class="r"><code># {r}
DBI::dbDisconnect(con)</code></pre>
</div>
<div id="get-intersection-between-program-area-shapefile-and-the-selected-properties" class="section level4">
<h4>Get intersection between program area shapefile and the selected properties</h4>
<p>First convert database query result to an sf object.</p>
<pre class="r"><code># {r}
db_rows_cc &lt;- st_as_sf(qry_res, coords = c(&quot;property_centroid_longitude&quot;, &quot;property_centroid_latitude&quot;), crs = 4326)

int &lt;- sf::st_intersects(db_rows_cc, map_program_area_cc)
int2 &lt;- as.integer(as.character(int))</code></pre>
</div>
<div id="add-rusid-to-intersecting-properties" class="section level4">
<h4>Add RUSID to intersecting properties</h4>
<pre class="r"><code># {r}
db_rows_cc$program &lt;- &quot;CC&quot;
db_rows_cc$rusid &lt;- as.character(map_program_area_cc$RUSID[unlist(int2)])
db_rows_cc &lt;- db_rows_cc[!is.na(db_rows_cc$rusid),]</code></pre>
</div>
</div>
<div id="rc-program-eligible-properties" class="section level3">
<h3>RC Program Eligible Properties</h3>
<div id="load-broadband-program-area-shapefiles-1" class="section level4">
<h4>Load broadband program area shapefiles</h4>
<pre class="r"><code># {r, cache=TRUE}
map_program_area_rc &lt;- st_read(file.path(geodatadir, &quot;ReConnect R1 594 PFSA 05012020.shp&quot;)) %&gt;%
  sf::st_transform(4326)</code></pre>
</div>
<div id="create-list-of-county-fips-codes-that-are-within-the-program-area-for-the-database-query-1" class="section level4">
<h4>Create list of county FIPS codes that are within the program area for the database query</h4>
<p>This dataset does not have a county FIPS code. Instead it provides a list of county names associated with that entry. We need to do some work to convert these lists of county names to a list of unique county fips codes.</p>
<pre class="r"><code># {r}
int &lt;- sf::st_intersects(map_program_area_rc, counties_us)

cnty_ints &lt;- data.table(rc_rownum = numeric(), cntys_rownum = numeric(), geoid = character())
for (i in 1:length(int)) {
  u &lt;- unlist(int[i])
  for (j in 1:length(int[[i]])) {
    geoid &lt;- counties_us[u[j],]$GEOID
    newrow &lt;- data.table(rc_rownum = i, cntys_rownum = u[j], geoid)
    cnty_ints &lt;- rbindlist(list(cnty_ints, newrow))
    #print(paste(i, u[j]))
  }
}

cnty_ints_geoid &lt;- cnty_ints[, .(geoid_cntys = paste(geoid, collapse = &quot;, &quot;)), rc_rownum]
map_program_area_rc$geoid_cnty &lt;- &quot;&quot;

for (i in 1:nrow(cnty_ints_geoid)) {
  map_program_area_rc[cnty_ints_geoid[i,]$rc_rownum,]$geoid_cnty &lt;- cnty_ints_geoid[i,]$geoid_cntys
}

geoid_cnty_unq &lt;- unique(strsplit(paste(map_program_area_rc$geoid_cnty, collapse = &quot;, &quot;), &quot;, &quot;)[[1]])
geoid_cnty_unq &lt;- geoid_cnty_unq[geoid_cnty_unq != &quot;&quot;]
counties_rc &lt;- paste0(&quot;&#39;&quot;, paste(geoid_cnty_unq, collapse = &quot;&#39;,&#39;&quot;), &quot;&#39;&quot;)

counties_rc_sql &lt;- glue_sql(counties_rc)</code></pre>
</div>
<div id="get-property-records-for-the-program-related-counties-from-the-database-1" class="section level4">
<h4>Get property records for the program related counties from the database</h4>
<pre class="r"><code># {r}
con &lt;- get_db_conn(db_host = &quot;localhost&quot;, db_port = 5434)</code></pre>
<pre class="sql"><code>-- {sql connection=con, output.var=&quot;qry_res&quot;}
SELECT geoid_cnty, p_id_iris_frmtd, property_centroid_longitude, property_centroid_latitude FROM corelogic_usda.current_tax_200627_latest_all_add_vars 
WHERE property_centroid_longitude IS NOT NULL 
AND geoid_cnty IN (?counties_rc_sql);</code></pre>
<pre class="r"><code># {r}
DBI::dbDisconnect(con)</code></pre>
</div>
<div id="get-intersection-between-program-area-shapefile-and-the-selected-properties-1" class="section level4">
<h4>Get intersection between program area shapefile and the selected properties</h4>
<p>First convert database query result to an sf object.</p>
<pre class="r"><code># {r}
db_rows_rc &lt;- st_as_sf(qry_res, coords = c(&quot;property_centroid_longitude&quot;, &quot;property_centroid_latitude&quot;), crs = 4326)

int &lt;- sf::st_intersects(db_rows_rc, map_program_area_rc)
int2 &lt;- as.integer(as.character(int))</code></pre>
</div>
<div id="add-rusid-to-intersecting-properties-1" class="section level4">
<h4>Add RUSID to intersecting properties</h4>
<pre class="r"><code># {r}
db_rows_rc$program &lt;- &quot;RC&quot;
db_rows_rc$rusid &lt;- as.character(map_program_area_rc$RUS_ID[unlist(int2)])
db_rows_rc &lt;- db_rows_rc[!is.na(db_rows_rc$rusid),]</code></pre>
</div>
</div>
<div id="bip-program-eligible-properties" class="section level3">
<h3>BIP Program Eligible Properties</h3>
<div id="load-broadband-program-area-shapefiles-2" class="section level4">
<h4>Load broadband program area shapefiles</h4>
<pre class="r"><code># {r, cache=TRUE}
map_program_area_bip &lt;- st_read(file.path(geodatadir, &quot;200409_BIP_ServAr_ID.shp&quot;)) %&gt;%
  sf::st_transform(4326)</code></pre>
</div>
<div id="create-list-of-county-fips-codes-that-are-within-the-program-area-for-the-database-query-2" class="section level4">
<h4>Create list of county FIPS codes that are within the program area for the database query</h4>
<p>This dataset does not have a county FIPS code. Instead it provides a list of county names associated with that entry. We need to do some work to convert these lists of county names to a list of unique county fips codes.</p>
<pre class="r"><code># {r}
int &lt;- sf::st_intersects(map_program_area_bip, counties_us)

cnty_ints &lt;- data.table(rc_rownum = numeric(), cntys_rownum = numeric(), geoid = character())
for (i in 1:length(int)) {
  u &lt;- unlist(int[i])
  for (j in 1:length(int[[i]])) {
    geoid &lt;- counties_us[u[j],]$GEOID
    newrow &lt;- data.table(rc_rownum = i, cntys_rownum = u[j], geoid)
    cnty_ints &lt;- rbindlist(list(cnty_ints, newrow))
  }
}

cnty_ints_geoid &lt;- cnty_ints[, .(geoid_cntys = paste(geoid, collapse = &quot;, &quot;)), rc_rownum]
map_program_area_bip$geoid_cnty &lt;- &quot;&quot;

for (i in 1:nrow(cnty_ints_geoid)) {
  map_program_area_bip[cnty_ints_geoid[i,]$rc_rownum,]$geoid_cnty &lt;- cnty_ints_geoid[i,]$geoid_cntys
}

geoid_cnty_unq &lt;- unique(strsplit(paste(map_program_area_bip$geoid_cnty, collapse = &quot;, &quot;), &quot;, &quot;)[[1]])
geoid_cnty_unq &lt;- geoid_cnty_unq[geoid_cnty_unq != &quot;&quot;]
counties_bip &lt;- paste0(&quot;&#39;&quot;, paste(geoid_cnty_unq, collapse = &quot;&#39;,&#39;&quot;), &quot;&#39;&quot;)

counties_bip_sql &lt;- glue_sql(counties_bip)</code></pre>
</div>
<div id="get-property-records-for-the-program-related-counties-from-the-database-2" class="section level4">
<h4>Get property records for the program related counties from the database</h4>
<pre class="r"><code># {r}
con &lt;- get_db_conn(db_host = &quot;localhost&quot;, db_port = 5434)</code></pre>
<pre class="sql"><code>-- {sql connection=con, output.var=&quot;qry_res&quot;}
SELECT geoid_cnty, p_id_iris_frmtd, property_centroid_longitude, property_centroid_latitude FROM corelogic_usda.current_tax_200627_latest_all_add_vars 
WHERE property_centroid_longitude IS NOT NULL
AND property_centroid_latitude IS NOT NULL
AND geoid_cnty IN (?counties_bip_sql);</code></pre>
<pre class="r"><code># {r}
DBI::dbDisconnect(con)</code></pre>
</div>
<div id="get-intersection-between-program-area-shapefile-and-the-selected-properties-2" class="section level4">
<h4>Get intersection between program area shapefile and the selected properties</h4>
<p>First convert database query result to an sf object.</p>
<pre class="r"><code># {r}
db_rows_bip &lt;- st_as_sf(qry_res, coords = c(&quot;property_centroid_longitude&quot;, &quot;property_centroid_latitude&quot;), crs = 4326)

int &lt;- sf::st_intersects(db_rows_bip, map_program_area_bip)
int2 &lt;- as.integer(as.character(int))</code></pre>
</div>
<div id="add-rusid-to-intersecting-properties-2" class="section level4">
<h4>Add RUSID to intersecting properties</h4>
<pre class="r"><code># {r}
db_rows_bip$program &lt;- &quot;BIP&quot;
db_rows_bip$rusid &lt;- as.character(map_program_area_bip$RUS_ID[unlist(int2)])
db_rows_bip &lt;- db_rows_bip[!is.na(db_rows_bip$rusid),]</code></pre>
</div>
</div>
<div id="tcf-program-eligible-properties" class="section level3">
<h3>TCF Program Eligible Properties</h3>
<div id="load-broadband-program-area-shapefiles-3" class="section level4">
<h4>Load broadband program area shapefiles</h4>
<pre class="r"><code># {r, cache=TRUE}
map_program_area_tcf &lt;- st_read(file.path(geodatadir, &quot;USDARD_RUS_TELCO_FARMBILL_06042020/USDARD_RUS_TELCO_FARMBILL_06042020.shp&quot;)) %&gt;%
  sf::st_transform(4326)</code></pre>
</div>
<div id="create-list-of-county-fips-codes-that-are-within-the-program-area-for-the-database-query-3" class="section level4">
<h4>Create list of county FIPS codes that are within the program area for the database query</h4>
<p>This dataset does not have a county FIPS code. Instead it provides a list of county names associated with that entry. We need to do some work to convert these lists of county names to a list of unique county fips codes.</p>
<pre class="r"><code># {r}
int &lt;- sf::st_intersects(map_program_area_tcf, counties_us)

cnty_ints &lt;- data.table(rc_rownum = numeric(), cntys_rownum = numeric(), geoid = character())
for (i in 1:length(int)) {
  u &lt;- unlist(int[i])
  for (j in 1:length(int[[i]])) {
    geoid &lt;- counties_us[u[j],]$GEOID
    newrow &lt;- data.table(rc_rownum = i, cntys_rownum = u[j], geoid)
    cnty_ints &lt;- rbindlist(list(cnty_ints, newrow))
    #print(paste(i, u[j]))
  }
}

cnty_ints_geoid &lt;- cnty_ints[, .(geoid_cntys = paste(geoid, collapse = &quot;, &quot;)), rc_rownum]
map_program_area_tcf$geoid_cnty &lt;- &quot;&quot;

for (i in 1:nrow(cnty_ints_geoid)) {
  map_program_area_tcf[cnty_ints_geoid[i,]$rc_rownum,]$geoid_cnty &lt;- cnty_ints_geoid[i,]$geoid_cntys
}

geoid_cnty_unq &lt;- unique(strsplit(paste(map_program_area_tcf$geoid_cnty, collapse = &quot;, &quot;), &quot;, &quot;)[[1]])
geoid_cnty_unq &lt;- geoid_cnty_unq[geoid_cnty_unq != &quot;&quot;]
counties_tcf &lt;- paste0(&quot;&#39;&quot;, paste(geoid_cnty_unq, collapse = &quot;&#39;,&#39;&quot;), &quot;&#39;&quot;)

counties_tcf_sql &lt;- glue_sql(counties_tcf)</code></pre>
</div>
<div id="get-property-records-for-the-program-related-counties-from-the-database-3" class="section level4">
<h4>Get property records for the program related counties from the database</h4>
<pre class="r"><code># {r}
con &lt;- get_db_conn(db_host = &quot;localhost&quot;, db_port = 5434)</code></pre>
<pre class="sql"><code>-- {sql connection=con, output.var=&quot;qry_res&quot;}
SELECT geoid_cnty, p_id_iris_frmtd, property_centroid_longitude, property_centroid_latitude FROM corelogic_usda.current_tax_200627_latest_all_add_vars 
WHERE property_centroid_longitude IS NOT NULL 
AND property_centroid_latitude IS NOT NULL
AND geoid_cnty IN (?counties_tcf_sql);</code></pre>
<pre class="r"><code># {r}
DBI::dbDisconnect(con)</code></pre>
</div>
<div id="get-intersection-between-program-area-shapefile-and-the-selected-properties-3" class="section level4">
<h4>Get intersection between program area shapefile and the selected properties</h4>
<p>First convert database query result to an sf object.</p>
<pre class="r"><code># {r}
db_rows_tcf &lt;- st_as_sf(qry_res, coords = c(&quot;property_centroid_longitude&quot;, &quot;property_centroid_latitude&quot;), crs = 4326)

int &lt;- sf::st_intersects(db_rows_tcf, map_program_area_tcf)
int2 &lt;- as.integer(as.character(int))</code></pre>
</div>
</div>
<div id="add-rusid-to-intersecting-properties-3" class="section level3">
<h3>Add RUSID to intersecting properties</h3>
<pre class="r"><code># {r}
db_rows_tcf$program &lt;- &quot;TCF&quot;
db_rows_tcf$rusid &lt;- as.character(map_program_area_tcf$RUS_ID[unlist(int2)])
db_rows_tcf &lt;- db_rows_tcf[!is.na(db_rows_tcf$rusid),]</code></pre>
</div>
<div id="tci-program-eligible-properties" class="section level3">
<h3>TCI Program Eligible Properties</h3>
<div id="load-broadband-program-area-shapefiles-4" class="section level4">
<h4>Load broadband program area shapefiles</h4>
<pre class="r"><code># {r, cache=TRUE}
map_program_area_tci &lt;- st_read(file.path(geodatadir, &quot;USDARD_RUS_TELCO_INFRA_06042020/USDARD_RUS_TELCO_INFRA_06042020.shp&quot;)) %&gt;%
  sf::st_transform(4326)</code></pre>
</div>
<div id="create-list-of-county-fips-codes-that-are-within-the-program-area-for-the-database-query-4" class="section level4">
<h4>Create list of county FIPS codes that are within the program area for the database query</h4>
<p>This dataset does not have a county FIPS code. Instead it provides a list of county names associated with that entry. We need to do some work to convert these lists of county names to a list of unique county fips codes.</p>
<pre class="r"><code># {r}
int &lt;- sf::st_intersects(map_program_area_tci, counties_us)

cnty_ints &lt;- data.table(rc_rownum = numeric(), cntys_rownum = numeric(), geoid = character())
for (i in 1:length(int)) {
  u &lt;- unlist(int[i])
  for (j in 1:length(int[[i]])) {
    geoid &lt;- counties_us[u[j],]$GEOID
    newrow &lt;- data.table(rc_rownum = i, cntys_rownum = u[j], geoid)
    cnty_ints &lt;- rbindlist(list(cnty_ints, newrow))
    #print(paste(i, u[j]))
  }
}

cnty_ints_geoid &lt;- cnty_ints[, .(geoid_cntys = paste(geoid, collapse = &quot;, &quot;)), rc_rownum]
map_program_area_tci$geoid_cnty &lt;- &quot;&quot;

for (i in 1:nrow(cnty_ints_geoid)) {
  map_program_area_tci[cnty_ints_geoid[i,]$rc_rownum,]$geoid_cnty &lt;- cnty_ints_geoid[i,]$geoid_cntys
}

geoid_cnty_unq &lt;- unique(strsplit(paste(map_program_area_tci$geoid_cnty, collapse = &quot;, &quot;), &quot;, &quot;)[[1]])
geoid_cnty_unq &lt;- geoid_cnty_unq[geoid_cnty_unq != &quot;&quot;]
counties_tci &lt;- paste0(&quot;&#39;&quot;, paste(geoid_cnty_unq, collapse = &quot;&#39;,&#39;&quot;), &quot;&#39;&quot;)

counties_tci_sql &lt;- glue_sql(counties_tci)</code></pre>
</div>
<div id="get-property-records-for-the-program-related-counties-from-the-database-4" class="section level4">
<h4>Get property records for the program related counties from the database</h4>
<pre class="r"><code># {r}
con &lt;- get_db_conn(db_host = &quot;localhost&quot;, db_port = 5434)</code></pre>
<pre class="sql"><code>-- {sql connection=con, output.var=&quot;qry_res&quot;}
SELECT geoid_cnty, p_id_iris_frmtd, property_centroid_longitude, property_centroid_latitude FROM corelogic_usda.current_tax_200627_latest_all_add_vars 
WHERE property_centroid_longitude IS NOT NULL 
AND property_centroid_latitude IS NOT NULL
AND geoid_cnty IN (?counties_tci_sql);</code></pre>
<pre class="r"><code># {r}
DBI::dbDisconnect(con)</code></pre>
</div>
<div id="get-intersection-between-program-area-shapefile-and-the-selected-properties-4" class="section level4">
<h4>Get intersection between program area shapefile and the selected properties</h4>
<p>First convert database query result to an sf object.</p>
<pre class="r"><code># {r}
db_rows_tci &lt;- st_as_sf(qry_res, coords = c(&quot;property_centroid_longitude&quot;, &quot;property_centroid_latitude&quot;), crs = 4326)

int &lt;- sf::st_intersects(db_rows_tci, map_program_area_tci)
int2 &lt;- as.integer(as.character(int))</code></pre>
</div>
<div id="add-rusid-to-intersecting-properties-4" class="section level4">
<h4>Add RUSID to intersecting properties</h4>
<pre class="r"><code># {r}
db_rows_tci$program &lt;- &quot;TCI&quot;
db_rows_tci$rusid &lt;- as.character(map_program_area_tci$RUSID[unlist(int2)])
db_rows_tci &lt;- db_rows_tci[!is.na(db_rows_tci$rusid),]</code></pre>
</div>
</div>
<div id="combine-all-program-eligible-properties" class="section level3">
<h3>Combine All Program Eligible Properties</h3>
<pre class="r"><code># {r}
combn &lt;- rbindlist(list(db_rows_cc, db_rows_rc, db_rows_bip, db_rows_tcf, db_rows_tci))

combn_cast &lt;- dcast(combn, geoid_cnty + p_id_iris_frmtd ~ program, value.var = &quot;rusid&quot;)

saveRDS(combn_cast, file.path(geodatadir, &quot;program_eligible_properties.RDS&quot;))</code></pre>
</div>
<div id="write-combined-data-to-the-database" class="section level3">
<h3>Write combined data to the database</h3>
<pre class="r"><code># {r}
con &lt;- get_db_conn(db_host = &quot;localhost&quot;, db_port = 5434)

dbWriteTable(con, c(&quot;corelogic_usda&quot;, &quot;current_tax_200627_program_eligible_properties&quot;), combn_cast, overwrite = TRUE, row.names = FALSE)

dbExecute(con, &quot;ALTER TABLE corelogic_usda.current_tax_200627_program_eligible_properties ADD PRIMARY KEY (geoid_cnty, p_id_iris_frmtd)&quot;)

DBI::dbDisconnect(con)</code></pre>
</div>
<div id="join-new-table-with-current_tax_200627_latest_all_add_vars" class="section level3">
<h3>Join new table with current_tax_200627_latest_all_add_vars</h3>
<pre class="sql"><code>-- {sql} * Run In psql/pgcli
SELECT a.*, b.&quot;BIP&quot;, b.&quot;CC&quot;, b.&quot;RC&quot;, b.&quot;TCF&quot;, b.&quot;TCI&quot;
INTO corelogic_usda.current_tax_200627_latest_all_add_vars_add_progs
FROM corelogic_usda.current_tax_200627_latest_all_add_vars a
LEFT JOIN corelogic_usda.current_tax_200627_program_eligible_properties b
ON a.geoid_cnty = b.geoid_cnty AND a.p_id_iris_frmtd = b.p_id_iris_frmtd;

ALTER TABLE corelogic_usda.current_tax_200627_latest_all_add_vars_add_progs ADD PRIMARY KEY (geoid_cnty, p_id_iris_frmtd);</code></pre>
<hr />
</div>
</div>
</div>
<div id="improve-quality" class="section level1">
<h1>IMPROVE QUALITY</h1>
<div id="filter-records" class="section level2">
<h2>FILTER RECORDS</h2>
<pre class="sql"><code>-- {sql}
SELECT
  geoid_cnty,
  sale_yr,
  pri_cat_code_req,
  have_all
FROM
(
SELECT
  geoid_cnty,
  LEFT(sale_date, 4) sale_yr,
  &#39;TRUE&#39; pri_cat_code_req,
  count(*) have_all
FROM
  corelogic_usda.broadband_variables_tax_2020_06_27_unq_prog
WHERE
--  (geoid_cnty LIKE &#39;51%&#39; OR geoid_cnty LIKE &#39;19%&#39;)
-- AND
  property_indicator = &#39;10&#39;
AND
  transaction_type != &#39;9&#39;
AND
  sale_date IS NOT NULL
AND
  sale_price IS NOT NULL
AND
  (building_square_feet IS NOT NULL OR living_square_feet IS NOT NULL)
AND
 (acres IS NOT NULL OR land_square_footage IS NOT NULL)
AND
 (year_built IS NOT NULL OR effective_year_built IS NOT NULL)
AND
 (full_baths IS NOT NULL OR \&quot;1qtr_baths\&quot; IS NOT NULL OR \&quot;3qtr_baths\&quot; IS NOT NULL OR half_baths IS NOT NULL OR total_baths IS NOT NULL)
AND
  pri_cat_code IS NOT NULL
AND
  LEFT(sale_date, 4) IN (&#39;2006&#39;, &#39;2007&#39;,&#39;2008&#39;,&#39;2009&#39;,&#39;2010&#39;,&#39;2011&#39;,&#39;2012&#39;,&#39;2013&#39;,&#39;2014&#39;,&#39;2015&#39;,&#39;2016&#39;,&#39;2017&#39;,&#39;2018&#39;)
GROUP BY
  geoid_cnty,
  LEFT(sale_date, 4)
</code></pre>
</div>
</div>
<div id="profile-final-dataset" class="section level1">
<h1>Profile Final Dataset</h1>
<div id="individual-variables-longitudinally" class="section level2">
<h2>Individual Variables (Longitudinally)</h2>
</div>
<div id="consistency-between-variables" class="section level2">
<h2>Consistency Between Variables</h2>
</div>
</div>



</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->

<script>
$(document).ready(function ()  {

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3,h4",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_');
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
