---
title: "Add Variables by Transorming Existing Columns"
output: 
  html_document:
    toc: yes
    toc_float: yes
---

```{r, include=FALSE}
knitr::opts_chunk$set(
  eval=FALSE
)
```

## Load libraries and functions

```{r}
# {r}
source("../R/functions.R")
```

## Create baths_appraised and sale_year

#### Sale Year

Planned analyses include analysis by year of sale. Creating a separate indexed column for year should be faster than repeatedly using DATEPART('year', sale_date).

#### Bathrooms

Using the Fannie Mae and Freddie Mac Uniform Appraisal Dataset Specification to calculate total bathrooms. 3/4 baths count as full baths, 1/4 baths are dropped, half bath is .1 of full bath, so 1 x full bath & 1 x 3/4 bath & 1 x half bath = 2.1 baths (2 full baths, 1 half bath).

```{sql}
-- {sql} * Run In psql/pgcli
SELECT *,
       DATE_PART('year', sale_date)::INTEGER AS sale_year,
       NULLIF(coalesce(full_baths, 0) + coalesce(thrqtr_baths, 0) + (.1 * coalesce(half_baths, 0)), 0) AS baths_appraised
INTO corelogic_usda.current_tax_200627_latest_all_add_vars
FROM corelogic_usda.current_tax_200627_latest_all;

ALTER TABLE corelogic_usda.current_tax_200627_latest_all_add_vars ADD PRIMARY KEY (geoid_cnty, p_id_iris_frmtd);
```

### First, Fix Longitude and Latitude Column Names!

The column names are switched in this dataset! Longitude is latitude and vice versa.

```{sql}
-- {sql} * Run In psql/pgcli
ALTER TABLE corelogic_usda.current_tax_200627_latest_all_add_vars RENAME COLUMN property_centroid_longitude TO property_centroid_latitude_;
ALTER TABLE corelogic_usda.current_tax_200627_latest_all_add_vars RENAME COLUMN property_centroid_latitude TO property_centroid_longitude;
ALTER TABLE corelogic_usda.current_tax_200627_latest_all_add_vars RENAME COLUMN property_centroid_latitude_ TO property_centroid_latitude;
```
