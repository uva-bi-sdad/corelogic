---
title: "Transformations: Spatial Translations and New Variables"
output: 
  html_document:
    toc: yes
    toc_float: yes
---

```{r, include=FALSE}
knitr::opts_chunk$set(
  eval=FALSE
)
```

------------------------------------------------------------------------

## FCC

### Form 477

-   Get the maximum speed per census block where data is available in FCC data
-   Compare that maximum speed to our eligibility threshold

#### 2014 DATA

For the year 2014, we used a combined speed threshold using the maximum advertised download and upload speeds. After testing a number of different thresholds (10/1, 4/1, 4/768, combined 3), we selected a combined value threshold of 5 Mbps, meaning the combined maximum advertised upload and download speeds needed to sum below 5 Mbps to be considered eligible.

```{r}
fcc_2014 <- read.csv("/project/biocomplexity/sdad/projects_data/project_data/usda/rural_broadband/fcc_availability/fbd_us_without_satellite_dec2014_v3.csv")

# #threshold of 3 mbps (download + upload)
fcc_2014_block_max_ <- fcc_2014 %>%
  group_by(StateAbbr, BlockCode) %>%
  summarise(MaxAdDown_ = max(MaxAdDown),
            MaxAdUp_ = max(MaxAdUp)) %>%
  mutate(total_speed = MaxAdDown_ + MaxAdUp_,
         speed_elig_down = NA, #ifelse(MaxAdDown_ >= 4, 0, 1),
         speed_elig_up = NA, #ifelse(MaxAdUp_ >= 0.768, 0, 1),
         speed_inelig = ifelse(total_speed < 3, 1, 0),
         speed_elig = ifelse(total_speed >= 3, 0, 1))

saveRDS(fcc_2014_block_max_, "/project/biocomplexity/sdad/projects_data/project_data/usda/rural_broadband/fcc_availability/fcc_2014_block_maxspdelig_threshold_total3.RDS")
```

#### 2018 DATA

For the year 2018, we used a straightforward speed threshold, where the maximum advertised download speed needed to sit below 10 Mbps AND the maximum upload speed needed to sit below 1 Mbps to be considered eligible.

```{r}
fcc_2018 <-
read.csv("/project/biocomplexity/sdad/projects_data/project_data/usda/rural_broadband/fcc_availability/fbd_us_without_satellite_dec2018_v2.csv")

fcc_2018_block_max <- fcc_2018 %>% group_by(StateAbbr, BlockCode) %>%
summarise(MaxAdDown_ = max(MaxAdDown), MaxAdUp_ = max(MaxAdUp)) %>%
mutate(speed_elig_down = ifelse(MaxAdDown_ >= 10, 0, 1), speed_elig_up
= ifelse(MaxAdUp_ >= 1, 0, 1), speed_inelig = ifelse(MaxAdDown_ >=
10 & MaxAdUp_ >= 1, 1, 0), speed_elig = ifelse(MaxAdDown_ >= 10 &
MaxAdUp_ >= 1, 0, 1))

# saveRDS(fcc_2018_block_max, "/project/biocomplexity/sdad/projects_data/project_data/usda/rural_broadband/fcc_availability/fcc_2018_block_maxspdelig.RDS")

```

## USDA

### Non-Rural Areas 2010-2020

Took shapefile

-   X intersected against counties to return TF - get counties where T - didn't use
-   X made boundaries valid - didn't use

1.  intersection against state (returns polygons)
2.  intersection against tract
3.  intersection against block

```{r}
### entire thing https://github.com/uva-bi-sdad/rural_broadband/blob/dtmn_elig/src/eligibility/usda_nonrural_areas_map_manip.Rmd

for (i in 4:nrow(files_to_intersect_)) {
  print(files_to_intersect_$state[i])
  options(tigris_use_cache = TRUE)
  tracts <- tigris::tracts(state = files_to_intersect_$state[i])
  tracts <- tracts %>% left_join(us_counties_x_urban, by = c( "STATEFP",  "COUNTYFP"))
  rural_cty_tracts <- tracts %>% filter(county_nonrural != 1 | is.na(county_nonrural))
  
  
  
  if(nrow(rural_cty_tracts) != nrow(tracts) ) {
    # INTERSECTION WITH TRACTS - get tract level polygons
    nonrural_cty_tracts <- tracts %>% filter(county_nonrural == 1)
    nonrural <- readRDS(files_to_intersect_$nr_path[i])
    nonrural_cty_tracts_polygons <- st_intersection(nonrural_cty_tracts, nonrural)
    saveRDS(nonrural_cty_tracts_polygons, file = paste0("/project/biocomplexity/sdad/projects_data/project_data/usda/rural_broadband/RECONNECT_NON_RURAL_working/nonruralstate_2018_", files_to_intersect_$state[i],"_nonruraltracts_polygons.RDS"))
    
    # INTERSECT TRACT POLYGONS WITH BLOCKS - get block level YES/NO nonrural
    blocks <- readRDS(files_to_intersect_$cb_paths[i])
    blocks <- blocks %>% left_join(us_counties_x_urban, by = c("STATEFP10" = "STATEFP", "COUNTYFP10" = "COUNTYFP"))
    rural_cty_blocks <- blocks %>% filter(county_nonrural != 1|is.na(county_nonrural))
    nonrural_cty_blocks <- blocks %>% filter(county_nonrural == 1)
    
    blocks_nonrural_tract_vector <- st_intersects(nonrural_cty_blocks, nonrural_cty_tracts_polygons)
    nonrural_cty_blocks$nonruralTF <- blocks_nonrural_tract_vector %>% lengths > 0 
    
    blocks <- rbind(rural_cty_blocks %>% mutate(nonruralTF = 0), nonrural_cty_blocks)
    
    saveRDS(blocks, paste0(savepath, savepath_1, "blocks_2018_nonruralTF_sf_", files_to_intersect_$state[i], ".RDS"))
    
    blocks_df <- blocks %>% as.data.frame() %>% select(STATEFP10, COUNTYFP10, TRACTCE10, BLOCKCE10, GEOID10, NAME10, nonruralTF)
    saveRDS(blocks_df, paste0(savepath, savepath_2, "blocks_2018_nonruralTF_df_", files_to_intersect_$state[i], ".RDS"))
  }
  
  if(nrow(rural_cty_blocks) == nrow(blocks) ) {
    print(files_to_intersect_$state[i])
    print("has no non-rural counties")
  }
  
}
```

### Protected Borrowers

Took shapefile intersection against block

```{r}
protborr <- sf::st_read("/project/biocomplexity/sdad/projects_data/project_data/usda/rural_broadband/rus_broadband_servicearea/ProtectedBorrowers04222019.shp")
protborr <- protborr %>% st_transform(st_crs(usa_blocks_speed_rural))
blocks_criteriaXprotborr_VECTOR <- st_intersects(usa_blocks_speed_rural, protborr) 
usa_blocks_speed_rural$protborr_inelg_vec <- blocks_criteriaXprotborr_VECTOR %>% lengths >0 

```

### USDA CAF II Spectrum Auction Winners

Took shapefile intersection against block

```{r}
caf2auctionwinners <- st_read("/project/biocomplexity/sdad/projects_data/usda/bb/original/Protected_bb_borrower_service_areas/Auction903_April2019.shp")
caf2auctionwinners <- caf2auctionwinners %>% st_transform(st_crs(usa_blocks_speed_rural))
blocks_criteriaXcaf2winners_VECTOR <- st_intersects(usa_blocks_speed_rural, caf2auctionwinners) 
usa_blocks_speed_rural$caf2_inelg_vec <- blocks_criteriaXcaf2winners_VECTOR %>% lengths >0 
```

### USDA Program Service Areas: Community Connect & ReConnect

```{r}
usa_blocks_speed_rural_projects_final_2014 <- readRDS("/project/biocomplexity/sdad/projects_data/project_data/usda/rural_broadband/USA_2014_final_eligibility_sf_08DEC2020v3.RDS")
usa_blocks_speed_rural_projects_final_2018 <- readRDS("/project/biocomplexity/sdad/projects_data/project_data/usda/rural_broadband/USA_2018_final_eligibility_sf_18NOV2020v2.RDS")

# BIP, TC does not have a date
# CC has a date - 2013-2020
# RC has a date - 2019-2020
# bip_areas <- sf::st_read("/project/biocomplexity/sdad/projects_data/project_data/usda/rural_broadband/RUS_BIP_Shapefiles_April2020/200409_BIP_ServAr_ID.shp") %>% sf::st_transform(sf::st_crs(usa_blocks_speed_rural_projects_final_2014))
cc_areas <- sf::st_read("/project/biocomplexity/sdad/projects_data/project_data/usda/rural_broadband/RUS_CC_Shapefiles_April2020/CC 2013_2019_83 04272020.shp") %>% sf::st_transform(sf::st_crs(usa_blocks_speed_rural_projects_final_2014))
cc_areas_2014andearlier <- cc_areas %>% filter(OBLFY <= 2014)
cc_areas_2018andearlier <- cc_areas %>% filter(OBLFY <= 2018 & OBLFY > 2014)
# tc_fb_areas <- sf::st_read("/project/biocomplexity/sdad/projects_data/project_data/usda/rural_broadband/RUS_TC_Shapefiles_June2020/USDARD_RUS_TELCO_FARMBILL_06042020/USDARD_RUS_TELCO_FARMBILL_06042020.shp") %>% sf::st_transform(sf::st_crs(usa_blocks_speed_rural_projects_final_2014))
# tc_inf_areas <- sf::st_read("/project/biocomplexity/sdad/projects_data/project_data/usda/rural_broadband/RUS_TC_Shapefiles_June2020/USDARD_RUS_TELCO_INFRA_06042020/USDARD_RUS_TELCO_INFRA_06042020.shp") %>% sf::st_transform(sf::st_crs(usa_blocks_speed_rural_projects_final_2014))

## CC 2014 - Block at CC Project Boundaries
eligblocks_cc14_crossbound <- sf::st_crosses(usa_blocks_speed_rural_projects_final_2014, st_boundary(cc_areas_2014andearlier))
usa_blocks_speed_rural_projects_final_2014$CC_14_RUSID_boundary <- cc_areas_2014andearlier$RUSID[ sapply(eligblocks_cc14_crossbound, first) ]
## CC 2014 - Block within CC Project Boundaries
eligblocks_cc14_within <- sf::st_within(usa_blocks_speed_rural_projects_final_2014,cc_areas_2014andearlier)
usa_blocks_speed_rural_projects_final_2014$CC_14_RUSID_inside <- cc_areas_2014andearlier$RUSID[ sapply(eligblocks_cc14_within, first) ]
## CC 2014 - Block intersects CC Project 
eligblocks_cc14_intersect <- sf::st_intersects(usa_blocks_speed_rural_projects_final_2014, cc_areas_2014andearlier)
usa_blocks_speed_rural_projects_final_2014$CC_14_RUSID_intersect <- cc_areas_2014andearlier$RUSID[ sapply(eligblocks_cc14_intersect, first) ]

# saveRDS(usa_blocks_speed_rural_projects_final_2014, "/project/biocomplexity/sdad/projects_data/project_data/usda/rural_broadband/USA_2014_final_eligibility_sf_14DEC2020v5.RDS")
usa_blocks_speed_rural_projects_final_2014 <- readRDS("/project/biocomplexity/sdad/projects_data/project_data/usda/rural_broadband/USA_2014_final_eligibility_sf_14DEC2020v5.RDS")

##########


## CC 2018 - Block at CC Project Boundaries
eligblocks_cc18_crossbound <- sf::st_crosses(usa_blocks_speed_rural_projects_final_2018, st_boundary(cc_areas_2018andearlier))
usa_blocks_speed_rural_projects_final_2018$CC_18_RUSID_boundary <- cc_areas_2018andearlier$RUSID[ sapply(eligblocks_cc18_crossbound, first) ]
## CC 2018 - Block within CC Project Boundaries
eligblocks_cc18_within <- sf::st_within(usa_blocks_speed_rural_projects_final_2018,cc_areas_2018andearlier)
usa_blocks_speed_rural_projects_final_2018$CC_18_RUSID_inside <- cc_areas_2018andearlier$RUSID[ sapply(eligblocks_cc18_within, first) ]
## CC 2018 - Block intersects CC Project 
eligblocks_cc18_intersect <- sf::st_intersects(usa_blocks_speed_rural_projects_final_2018, cc_areas_2018andearlier)
usa_blocks_speed_rural_projects_final_2018$CC_18_RUSID_intersect <- cc_areas_2018andearlier$RUSID[ sapply(eligblocks_cc18_intersect, first) ]

# saveRDS(usa_blocks_speed_rural_projects_final_2018, "/project/biocomplexity/sdad/projects_data/project_data/usda/rural_broadband/USA_2018_final_eligibility_sf_14DEC2020v5.RDS")
usa_blocks_speed_rural_projects_final_2014 <- readRDS("/project/biocomplexity/sdad/projects_data/project_data/usda/rural_broadband/USA_2014_final_eligibility_sf_14DEC2020v5.RDS")
usa_blocks_speed_rural_projects_final_2018 <- readRDS("/project/biocomplexity/sdad/projects_data/project_data/usda/rural_broadband/USA_2018_final_eligibility_sf_14DEC2020v5.RDS")

rc_areas <- sf::st_read("/project/biocomplexity/sdad/projects_data/project_data/usda/rural_broadband/RUS_RC_Shapefiles_April2020/ReConnect R1 594 PFSA 05012020.shp") %>% sf::st_transform(sf::st_crs(usa_blocks_speed_rural_projects_final_2018))

## RC 2018 - Block at RC Project Boundaries
eligblocks_rc18_crossbound <- sf::st_crosses(usa_blocks_speed_rural_projects_final_2018, st_boundary(rc_areas))
usa_blocks_speed_rural_projects_final_2018$RC_18_RUSID_boundary <- rc_areas$RUS_ID[ sapply(eligblocks_rc18_crossbound, first) ]
# saveRDS(usa_blocks_speed_rural_projects_final_2018, "/project/biocomplexity/sdad/projects_data/project_data/usda/rural_broadband/working/eligibility_summary_percentages/intermediates_delete/")
## RC 2018 - Block within RC Project Boundaries
eligblocks_rc18_within <- sf::st_within(usa_blocks_speed_rural_projects_final_2018,rc_areas)
usa_blocks_speed_rural_projects_final_2018$RC_18_RUSID_inside <- rc_areas$RUS_ID[ sapply(eligblocks_rc18_within, first) ]
## RC 2018 - Block intersects RC Project 
eligblocks_rc18_intersect <- sf::st_intersects(usa_blocks_speed_rural_projects_final_2018, rc_areas)
usa_blocks_speed_rural_projects_final_2018$RC_18_RUSID_intersect <- rc_areas$RUS_ID[ sapply(eligblocks_rc18_intersect, first) ]

# saveRDS(usa_blocks_speed_rural_projects_final_2018, "/project/biocomplexity/sdad/projects_data/project_data/usda/rural_broadband/working/eligibility_summary_percentages/intermediates_delete/usa_blocks_speed_rural_projects_final_2018WRC_sf.RDS")

join_18_rc <- usa_blocks_speed_rural_projects_final_2018 %>% 
  as.data.frame() %>% 
  select(GEOID10, BlockCode, RC_18_RUSID_boundary, RC_18_RUSID_inside, RC_18_RUSID_intersect)
```
